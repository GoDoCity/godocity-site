---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

// Treat a post as "daytona" if:
// - frontmatter city is "daytona", OR
// - legacy folder id starts with "daytona/"
function isDaytonaPost(p) {
  const city = String(p?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof p.id === "string" && p.id.startsWith("daytona/");
}

// URL-safe topic slug (canonical)
function slugifyTag(tag) {
  return String(tag ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

// Pretty label for display
function displayTag(tag) {
  return String(tag ?? "").trim().replace(/\s+/g, " ");
}

export async function getStaticPaths() {
  const posts = (await getCollection("posts")).filter(isDaytonaPost);

  return posts.map((p) => ({
    params: { slug: p.slug },
    props: { post: p },
  }));
}

const { post } = Astro.props;

const title = post.data.title;
const subtitle = post.data.description ?? "GoDoDaytona post";
const { Content } = await post.render();

// tags: normalize + keep display label + stable slug
const rawTags = Array.isArray(post.data?.tags) ? post.data.tags : [];
const tagObjects = rawTags
  .map((t) => {
    const label = displayTag(t);
    const slug = slugifyTag(t);
    return { label, slug };
  })
  .filter((t) => t.label && t.slug);

// de-dupe by slug, keep first label
const tagMap = new Map();
for (const t of tagObjects) {
  if (!tagMap.has(t.slug)) tagMap.set(t.slug, t.label);
}
const tags = Array.from(tagMap.entries()).map(([slug, label]) => ({ slug, label }));
---

<Base title={title} subtitle={subtitle} cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 780px;">
    <h1 class="h1">{post.data.title}</h1>
    {post.data.description && <p class="lede">{post.data.description}</p>}

    <p style="opacity:.6;margin-top:10px">
      {new Date(post.data.pubDate).toLocaleDateString()}
    </p>

    {tags.length > 0 && (
      <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:10px;">
        {tags.map((t) => (
          <a class="pill" href={`/daytona/topic/${t.slug}/`}>{t.label}</a>
        ))}
      </div>
    )}

    <article style="margin-top:18px;line-height:1.65">
      <Content />
    </article>

    <p style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/posts/">‚Üê All posts</a>
      <a class="pill" href="/daytona/topics/">Topics</a>
      <a class="pill" href="/daytona/">Daytona home</a>
    </p>
  </div>
</section>
