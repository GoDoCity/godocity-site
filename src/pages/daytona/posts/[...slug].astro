---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Rule A — Canonical Tag Normalization
 * - case-insensitive
 * - treats "motor sports", "motor-sports", "Motor Sports" as the same tag
 */

// canonical key for comparison/grouping
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

// URL slug from canonical key
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

// Display label from canonical key (Title Case)
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : ""))
    .join(" ");
}

// Daytona filter (supports explicit frontmatter and legacy folder IDs)
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

export async function getStaticPaths() {
  const posts = await getCollection("posts");

  const daytonaPosts = posts.filter((post) => {
    const city = String(post?.data?.city ?? "daytona").toLowerCase();
    if (city === "daytona") return true;
    return typeof post?.id === "string" && post.id.startsWith("daytona/");
  });

  return daytonaPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

const title = post.data.title;
const subtitle = post.data.description ?? "GoDoDaytona post";
const { Content } = await post.render();

// ---- Tags for THIS post (Rule A, unique) ----
const rawTags = Array.isArray(post.data?.tags) ? post.data.tags : [];
const currentKeySet = new Set(rawTags.map(tagKey).filter(Boolean));

const tagItems = Array.from(currentKeySet).map((key) => ({
  key,
  label: tagLabelFromKey(key),
  slug: tagSlugFromKey(key),
}));

// ---- Related posts (STRICT: shares >=1 canonical tag) ----
let relatedPosts = [];
if (currentKeySet.size > 0) {
  const all = (await getCollection("posts")).filter(isDaytonaPost);

  const overlapCount = (aSet, bSet) => {
    let c = 0;
    for (const v of aSet) if (bSet.has(v)) c++;
    return c;
  };

  relatedPosts = all
    .filter((p) => p.slug !== post.slug)
    .map((p) => {
      const tags = Array.isArray(p.data?.tags) ? p.data.tags : [];
      const pSet = new Set(tags.map(tagKey).filter(Boolean));
      return { p, overlap: overlapCount(currentKeySet, pSet) };
    })
    .filter((x) => x.overlap > 0)
    .sort((a, b) => {
      if (b.overlap !== a.overlap) return b.overlap - a.overlap;
      return +new Date(b.p.data.pubDate) - +new Date(a.p.data.pubDate);
    })
    .slice(0, 4)
    .map((x) => x.p);
}
---

<Base title={title} subtitle={subtitle} cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 780px;">
    <h1 class="h1">{title}</h1>
    {post.data.description && <p class="lede">{post.data.description}</p>}

    <p style="opacity:.6;margin-top:10px">
      {new Date(post.data.pubDate).toLocaleDateString()}
    </p>

    {tagItems.length > 0 && (
      <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:10px;">
        {tagItems.map((t) => (
          <a class="pill" href={`/daytona/topic/${t.slug}/`}>{t.label}</a>
        ))}
      </div>
    )}

    <article style="margin-top:18px;line-height:1.65">
      <Content />
    </article>

    {relatedPosts.length > 0 && (
      <section style="margin-top:30px;">
        <div style="display:flex;align-items:baseline;justify-content:space-between;gap:12px;">
          <h2 style="font-size:18px;font-weight:900;margin:0;">Related posts</h2>
          <span style="opacity:.6;font-size:13px;">Based on shared topics</span>
        </div>

        <div style="margin-top:12px;display:grid;gap:12px;">
          {relatedPosts.map((p) => (
            <a class="card" href={`/daytona/posts/${p.slug}/`} style="display:block;padding:16px;">
              <div style="font-weight:900">{p.data.title}</div>
              {p.data.description && (
                <div style="opacity:.82;margin-top:4px">{p.data.description}</div>
              )}
              <div style="opacity:.6;margin-top:6px">
                {new Date(p.data.pubDate).toLocaleDateString()}
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    <p style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/posts/">← All posts</a>
      <a class="pill" href="/daytona/topics/">Topics</a>
      <a class="pill" href="/daytona/">Daytona home</a>
    </p>
  </div>
</section>
