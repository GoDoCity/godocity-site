---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}
/**
 * Rule A — Canonical Tag Normalization
 * - case-insensitive
 * - treats "motor sports", "motor-sports", "Motor Sports" as the same tag
 */

// canonical key for comparison/grouping
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

// URL slug from canonical key
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

// Display label from canonical key (Title Case)
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : ""))
    .join(" ");
}

// Daytona filter (supports both explicit frontmatter and legacy folder IDs)
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

// Featured flag normalization
function isFeatured(post) {
  const v = post?.data?.featured;
  if (v === true) return true;
  if (v === 1) return true;
  const s = String(v ?? "").toLowerCase().trim();
  return s === "true" || s === "yes" || s === "1";
}

// Safe date getter (fallback order)
function getPostDate(post) {
  return (
    post?.data?.pubDate ??
    post?.data?.date ??
    post?.data?.published ??
    post?.data?.updated ??
    null
  );
}

// Sort newest first
function sortNewestFirst(a, b) {
  const da = new Date(getPostDate(a) ?? 0).getTime();
  const db = new Date(getPostDate(b) ?? 0).getTime();
  return db - da;
}

export async function getStaticPaths() {
  const posts = (await getCollection("posts")).filter(isDaytonaPost);

  return posts.map((post) => ({
    // For [...slug], Astro expects a STRING here (not an array)
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

const title = post.data.title;
const subtitle = post.data.description ?? "GoDoDaytona post";
const { Content } = await post.render();

// normalize tags for display + URL (Rule A)
const rawTags = Array.isArray(post.data?.tags) ? post.data.tags : [];
const uniqueKeySet = new Set(rawTags.map(tagKey).filter(Boolean));

const tagItems = Array.from(uniqueKeySet).map((key) => ({
  key,
  label: tagLabelFromKey(key),
  slug: tagSlugFromKey(key),
}));

// ---- Related posts (max 3 TOTAL, regardless of featured) ----
const allPosts = (await getCollection("posts")).filter(isDaytonaPost);

// current post canonical tag keys
const currentKeys = new Set(tagItems.map((t) => t.key));

// Only compute related if current post has tags
let related = [];
if (currentKeys.size > 0) {
  const candidates = allPosts.filter((p) => p.slug !== post.slug);

  const scored = candidates
    .map((p) => {
      const pTags = Array.isArray(p.data?.tags) ? p.data.tags : [];
      const pKeys = new Set(pTags.map(tagKey).filter(Boolean));

      // shared tag count
      let shared = 0;
      for (const k of pKeys) if (currentKeys.has(k)) shared++;

      return { post: p, shared };
    })
    // must share at least 1 tag
    .filter((x) => x.shared > 0)
    // sort by: most shared tags, then newest
    .sort((a, b) => {
      if (b.shared !== a.shared) return b.shared - a.shared;
      return sortNewestFirst(a.post, b.post);
    });

  // HARD CAP: slice ONCE at the end
  related = scored.slice(0, 3).map((x) => x.post);
}
---

<Base title={title} subtitle={subtitle} cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 780px;">
    <h1 class="h1">{title}</h1>
    {post.data.description && <p class="lede">{post.data.description}</p>}

    <p style="opacity:.6;margin-top:10px">
      {new Date(post.data.pubDate).toLocaleDateString()}
    </p>

    <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
      {isFeatured(post) && (
        <span
          style="
            font-size: 12px;
            font-weight: 800;
            letter-spacing: .04em;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,220,80,.65);
            color: rgba(255,220,80,.95);
            background: rgba(255,220,80,.12);
            white-space: nowrap;
          "
        >
          FEATURED
        </span>
      )}

      {tagItems.length > 0 && (
        <>
          {tagItems.map((t) => (
            <a class="pill" href={`/daytona/topic/${t.slug}/`}>{t.label}</a>
          ))}
        </>
      )}
    </div>

    <article style="margin-top:18px;line-height:1.65">
      <Content />
    </article>

    {related.length > 0 && (
      <div style="margin-top:26px;">
        <h2 style="font-size:18px;margin:0 0 10px 0;">Related posts</h2>

        <div style="display:flex;flex-direction:column;gap:12px;">
          {related.map((rp) => {
            const rTitle = rp.data.title ?? rp.slug;
            const rDesc = rp.data.description ?? "";
            const rDate = getPostDate(rp);
            const rDateText = rDate ? new Date(rDate).toLocaleDateString() : "";

            return (
              <a href={`/daytona/posts/${rp.slug}/`} style="text-decoration:none;display:block;">
                <div
                  style="
                    border: 1px solid rgba(255,255,255,.12);
                    border-radius: 14px;
                    padding: 14px 16px;
                    background: rgba(255,255,255,.03);
                  "
                >
                  <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
                    <div>
                      <div style="font-weight:700;font-size:16px;line-height:1.25">{rTitle}</div>
                      {rDesc && <div style="opacity:.8;margin-top:6px">{rDesc}</div>}
                      {rDateText && <div style="opacity:.6;margin-top:8px">{rDateText}</div>}
                    </div>

                    {isFeatured(rp) && (
                      <span
                        style="
                          font-size: 12px;
                          font-weight: 800;
                          letter-spacing: .04em;
                          padding: 6px 10px;
                          border-radius: 999px;
                          border: 1px solid rgba(255,220,80,.65);
                          color: rgba(255,220,80,.95);
                          background: rgba(255,220,80,.12);
                          white-space: nowrap;
                        "
                      >
                        FEATURED
                      </span>
                    )}
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </div>
    )}

    <p style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/posts/">← All posts</a>
      <a class="pill" href="/daytona/topics/">Topics</a>
    </p>
  </div>
</section>
