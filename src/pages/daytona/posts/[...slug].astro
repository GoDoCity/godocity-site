---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona filter (supports both explicit frontmatter city and legacy folder IDs)
 * IMPORTANT: must be in the SAME frontmatter block as getStaticPaths().
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/** Featured flag normalization */
function isFeatured(post) {
  const v = post?.data?.featured;
  if (v === true) return true;
  if (v === 1) return true;
  const s = String(v ?? "").toLowerCase().trim();
  return s === "true" || s === "yes" || s === "1";
}

/** Canonical tag normalization */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : ""))
    .join(" ");
}

/** Safe date getter */
function getPostDate(post) {
  return (
    post?.data?.pubDate ??
    post?.data?.date ??
    post?.data?.published ??
    post?.data?.updated ??
    null
  );
}
function sortNewestFirst(a, b) {
  const da = new Date(getPostDate(a) ?? 0).getTime();
  const db = new Date(getPostDate(b) ?? 0).getTime();
  return db - da;
}

/** Related posts logic (stable) */
const RELATED_LIMIT = 3;
const MAX_FEATURED_IN_RELATED = 1;

function normalizeTags(post) {
  const raw = Array.isArray(post?.data?.tags) ? post.data.tags : [];
  const keys = raw.map(tagKey).filter(Boolean);
  return Array.from(new Set(keys));
}
function sharedTagScore(aKeys, bKeys) {
  if (!aKeys.length || !bKeys.length) return 0;
  const set = new Set(aKeys);
  let score = 0;
  for (const k of bKeys) if (set.has(k)) score++;
  return score;
}
function buildRelatedPosts(currentPost, allCityPosts) {
  const currentSlug = currentPost?.slug;
  const currentKeys = normalizeTags(currentPost);

  const candidates = allCityPosts
    .filter((p) => p?.slug && p.slug !== currentSlug)
    .map((p) => {
      const keys = normalizeTags(p);
      const score = sharedTagScore(currentKeys, keys);
      const date = new Date(getPostDate(p) ?? 0).getTime();
      return { p, score, date };
    });

  candidates.sort((x, y) => {
    if (y.score !== x.score) return y.score - x.score;
    return y.date - x.date;
  });

  const withOverlap = candidates.filter((c) => c.score > 0).map((c) => c.p);
  const withoutOverlap = candidates.filter((c) => c.score === 0).map((c) => c.p);
  const ranked = [...withOverlap, ...withoutOverlap];

  const featured = ranked.filter(isFeatured);
  const nonFeatured = ranked.filter((p) => !isFeatured(p));

  const result = [];
  result.push(...featured.slice(0, MAX_FEATURED_IN_RELATED));
  result.push(...nonFeatured.slice(0, RELATED_LIMIT - result.length));

  const remaining = ranked.filter((p) => !result.some((r) => r.slug === p.slug));
  result.push(...remaining.slice(0, RELATED_LIMIT - result.length));

  return result.slice(0, RELATED_LIMIT);
}

/** getStaticPaths (build-safe) */
export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const daytonaPosts = posts.filter(isDaytonaPost).sort(sortNewestFirst);

  return daytonaPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

/** Page data */
const { post } = Astro.props;
const title = post.data.title;
const subtitle = post.data.description ?? "GoDo Daytona post";
const { Content } = await post.render();

const all = await getCollection("posts");
const daytonaPosts = all.filter(isDaytonaPost).sort(sortNewestFirst);

// tags for THIS post
const rawTags = Array.isArray(post.data?.tags) ? post.data.tags : [];
const uniqueKeySet = new Set(rawTags.map(tagKey).filter(Boolean));
const tagItems = Array.from(uniqueKeySet).map((key) => ({
  key,
  label: tagLabelFromKey(key),
  slug: tagSlugFromKey(key),
}));

// related
const relatedAll = buildRelatedPosts(post, daytonaPosts);
const seen = new Set();
const deduped = relatedAll.filter((p) => {
  if (seen.has(p.slug)) return false;
  seen.add(p.slug);
  return true;
});
const relatedPosts = [
  ...deduped.filter(isFeatured),
  ...deduped.filter((p) => !isFeatured(p)),
].slice(0, 3);

// date display
const pub = getPostDate(post);
const pubText = pub ? new Date(pub).toLocaleDateString("en-US") : "";
const featured = isFeatured(post);
---

<Base title={title} subtitle={subtitle} cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 780px;">
    <h1 class={`h1 postTitle ${featured ? "isFeatured" : ""}`}>{title}</h1>
    {post.data.description && <p class="lede">{post.data.description}</p>}

    {/* Date + tag pills inline */}
    <div class="metaRow">
      {pubText && <span class="metaDate">{pubText}</span>}

      {tagItems.length > 0 && (
        <span class="metaTags" aria-label="Topics">
          {tagItems.map((t) => (
            <a class="topicPill" href={`/daytona/topic/${t.slug}/`}>{t.label}</a>
          ))}
        </span>
      )}

      {featured && <span class="featuredPill">FEATURED</span>}
    </div>

    <article class="postBody">
      <Content />
    </article>

    {relatedPosts.length > 0 && (
      <div style="margin-top:26px;">
        <h3 style="margin:0 0 10px 0;font-size:16px;opacity:.9;">Related posts</h3>

        <div style="display:flex;flex-direction:column;gap:12px;">
          {relatedPosts.map((p) => {
            const t = p.data.title ?? p.slug;
            const desc = p.data.description ?? "";
            const d = getPostDate(p);
            const dateText = d ? new Date(d).toLocaleDateString("en-US") : "";

            return (
              <a href={`/daytona/posts/${p.slug}/`} style="text-decoration:none;display:block;">
                <div class="relatedCard">
                  <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
                    <div>
                      <div style="font-weight:800;font-size:16px;line-height:1.25">{t}</div>
                      {desc && <div style="opacity:.82;margin-top:6px">{desc}</div>}
                      {dateText && <div style="opacity:.6;margin-top:8px">{dateText}</div>}
                    </div>

                    {isFeatured(p) && <span class="featuredPill">FEATURED</span>}
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </div>
    )}

    <p style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/posts/">‚Üê All posts</a>
      <a class="pill" href="/daytona/topics/">Topics</a>
    </p>
  </div>
</section>

<style>
  /* Title: featured posts 15% bigger */
  .postTitle { margin: 0; }
  .postTitle.isFeatured { font-size: calc(1em * 1.15); }

  .postBody {
    margin-top: 18px;
    line-height: 1.65;
  }

  /* Meta row: date + tags inline */
  .metaRow{
    margin-top: 10px;
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:10px;
    opacity:.82;
  }
  .metaDate{ opacity:.75; }

  .metaTags{
    display:inline-flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }

  /* Smaller + ~30% faded yellow pills (and force override of global styles) */
  .metaRow .topicPill{
    display:inline-flex !important;
    align-items:center !important;
    justify-content:center !important;
    padding: 5px 10px !important;         /* smaller */
    border-radius: 999px !important;
    font-size: 11px !important;           /* smaller */
    font-weight: 800 !important;
    letter-spacing: .02em !important;
    text-decoration: none !important;

    color: #111 !important;
    background: rgba(255, 220, 80, 0.65) !important; /* ~30% faded vs .95 */
    border: 1px solid rgba(255, 220, 80, 0.55) !important;

    transition: transform .08s ease, filter .12s ease, opacity .12s ease;
  }
  .metaRow .topicPill:hover {
    transform: translateY(-1px);
    filter: brightness(1.02);
  }
  .metaRow .topicPill:active {
    transform: translateY(0px);
    opacity: .92;
  }

  .featuredPill {
    font-size: 12px;
    font-weight: 800;
    letter-spacing: .04em;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,220,80,.65);
    color: rgba(255,220,80,.95);
    background: rgba(255,220,80,.12);
    white-space: nowrap;
  }

  .relatedCard {
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    padding: 14px 16px;
    background: rgba(255,255,255,.03);
  }
</style>
