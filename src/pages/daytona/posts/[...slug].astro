---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * -------------------------------------------------------
 * Rule A â€” Canonical Tag Normalization
 * - case-insensitive
 * - treats "motor sports", "motor-sports", "Motor Sports" as identical
 * -------------------------------------------------------
 */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

/**
 * -------------------------------------------------------
 * Daytona post filter
 * -------------------------------------------------------
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;

  // legacy folder support: daytona/slug
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/**
 * -------------------------------------------------------
 * Static paths
 * -------------------------------------------------------
 */
export async function getStaticPaths() {
  const posts = (await getCollection("posts")).filter(isDaytonaPost);

  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

/**
 * -------------------------------------------------------
 * Page props
 * -------------------------------------------------------
 */
const { post } = Astro.props;

const title = post.data.title;
const description = post.data.description ?? "";
const publishDate = post.data.date;
const tags = post.data.tags ?? [];

// Normalize tags (Rule A)
const canonicalTagKeys = [...new Set(tags.map(tagKey))];

const tagLinks = canonicalTagKeys.map(key => ({
  key,
  label: tagLabelFromKey(key),
  slug: tagSlugFromKey(key),
  href: `/daytona/topic/${tagSlugFromKey(key)}/`
}));
---

<Base title={title} description={description}>
  <article class="post">

    <header class="post-header">
      <h1>{title}</h1>

      {publishDate && (
        <p class="post-date">
          {new Date(publishDate).toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric"
          })}
        </p>
      )}
    </header>

    <section class="post-content">
      <post.Content />
    </section>

    {tagLinks.length > 0 && (
      <footer class="post-tags">
        <h4>Topics</h4>
        <ul>
          {tagLinks.map(tag => (
            <li>
              <a href={tag.href}>{tag.label}</a>
            </li>
          ))}
        </ul>
      </footer>
    )}

  </article>
</Base>

<style>
.post {
  max-width: 760px;
  margin: 0 auto;
}

.post-header h1 {
  margin-bottom: 0.25rem;
}

.post-date {
  color: #888;
  font-size: 0.9rem;
}

.post-tags ul {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  list-style: none;
  padding: 0;
}

.post-tags a {
  text-decoration: none;
  font-size: 0.85rem;
  background: #222;
  padding: 0.35rem 0.6rem;
  border-radius: 4px;
}
</style>
