---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona filter (supports both explicit frontmatter city and legacy folder IDs)
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/**
 * Featured flag normalization
 */
function isFeatured(post) {
  const v = post?.data?.featured;
  if (v === true) return true;
  if (v === 1) return true;
  const s = String(v ?? "").toLowerCase().trim();
  return s === "true" || s === "yes" || s === "1";
}

/**
 * Canonical Tag Normalization
 */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : ""))
    .join(" ");
}

/**
 * Safe date getter (fallback order)
 */
function getPostDate(post) {
  return (
    post?.data?.pubDate ??
    post?.data?.date ??
    post?.data?.published ??
    post?.data?.updated ??
    null
  );
}

function sortNewestFirst(a, b) {
  const da = new Date(getPostDate(a) ?? 0).getTime();
  const db = new Date(getPostDate(b) ?? 0).getTime();
  return db - da;
}

const allPosts = await getCollection("posts");
const posts = allPosts.filter(isDaytonaPost).sort(sortNewestFirst);

function getTagItems(post) {
  const rawTags = Array.isArray(post?.data?.tags) ? post.data.tags : [];
  const uniqueKeySet = new Set(rawTags.map(tagKey).filter(Boolean));
  return Array.from(uniqueKeySet).map((key) => ({
    key,
    label: tagLabelFromKey(key),
    slug: tagSlugFromKey(key),
  }));
}

function formatDate(d) {
  if (!d) return "";
  try {
    return new Date(d).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
  } catch {
    return "";
  }
}
---

<Base title="Latest Posts" subtitle="GoDo Daytona posts" cityBase="daytona">
  <section class="section">
    <div class="container" style="max-width: 980px;">
      <p class="kicker">GODO DAYTONA / POSTS</p>
      <h1 class="h1">Latest Posts</h1>
      <p class="count">{posts.length} total</p>

      <ul class="post-list">
        {posts.map((post) => {
          const title = post.data?.title ?? post.slug;
          const desc = post.data?.description ?? "";
          const d = getPostDate(post);
          const dateText = formatDate(d);
          const tags = getTagItems(post);
          const url = `/daytona/posts/${post.slug}/`;

          return (
            <li class="post-item">
              {/* Stretched link makes the whole card clickable */}
              <a class="stretched-link" href={url} aria-label={`Open post: ${title}`}></a>

              {/* Featured badge (clickable overlay stays behind it) */}
              {isFeatured(post) && <span class="featuredPill">FEATURED</span>}

              {/* Card content is non-clickable so the stretched link wins;
                  tags explicitly re-enable pointer events. */}
              <div class="post-content">
                <div class="post-title">{title}</div>

                <div class="metaLine">
                  {dateText && <span class="post-date">{dateText}</span>}

                  {tags.length > 0 && (
                    <div class="tagRow">
                      {tags.map((t) => (
                        <a class="topicPill" href={`/daytona/topic/${t.slug}/`}>{t.label}</a>
                      ))}
                    </div>
                  )}
                </div>

                {desc && <div class="post-desc">{desc}</div>}
              </div>
            </li>
          );
        })}
      </ul>
    </div>
  </section>

  <style>
    .kicker {
      margin: 0 0 10px 0;
      font-weight: 900;
      letter-spacing: .12em;
      font-size: 12px;
      color: rgba(255,220,80,.95);
      text-transform: uppercase;
    }

    .count { margin: 6px 0 18px 0; opacity: .65; }

    .post-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 14px;
    }

    .post-item {
      position: relative;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 16px 16px;
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      overflow: hidden;
    }

    .post-item:hover {
      border-color: rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.04);
    }

    /* Whole-card click target */
    .stretched-link {
      position: absolute;
      inset: 0;
      z-index: 1;
      border-radius: 14px;
    }

    /* Content sits above, but doesn't steal the click */
    .post-content {
      position: relative;
      z-index: 2;
      pointer-events: none;
    }

    /* Title 15% larger-ish */
    .post-title {
      font-weight: 900;
      font-size: 18.5px; /* was ~16px */
      line-height: 1.15;
      margin: 0 0 10px 0;
    }

    /* Date + tags inline */
    .metaLine {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      opacity: .85;
    }

    .post-date {
      opacity: .8;
      font-weight: 700;
      font-size: 0.95em;
      white-space: nowrap;
    }

    /* Tags re-enable pointer events so they remain clickable */
    .tagRow {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 8px;
      pointer-events: auto;
      position: relative;
      z-index: 3;
    }

    /* Smaller pills + ~30% faded yellow */
    .topicPill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .02em;
      text-decoration: none;

      color: #111;
      background: rgba(255, 220, 80, 0.65); /* faded */
      border: 1px solid rgba(255, 220, 80, 0.65); /* faded */
      box-shadow: 0 0 0 1px rgba(0,0,0,0.06) inset;

      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
    }

    .topicPill:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
    }

    .topicPill:active {
      transform: translateY(0px);
      opacity: .92;
    }

    /* Description clamped to 2 lines (clean list) */
    .post-desc {
      margin-top: 10px;
      opacity: .82;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      pointer-events: none;
    }

    /* Featured badge top-right; clickable overlay stays behind it */
    .featuredPill {
      position: absolute;
      top: 14px;
      right: 14px;
      z-index: 4;
      pointer-events: none;

      font-size: 11px;
      font-weight: 900;
      letter-spacing: .04em;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,220,80,.65);
      color: rgba(255,220,80,.95);
      background: rgba(255,220,80,.12);
      white-space: nowrap;
    }
  </style>
</Base>
