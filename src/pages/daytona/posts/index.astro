---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona filter (supports frontmatter city and legacy folder IDs)
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/**
 * Featured flag normalization
 */
function isFeatured(post) {
  const v = post?.data?.featured;
  if (v === true) return true;
  if (v === 1) return true;
  const s = String(v ?? "").toLowerCase().trim();
  return s === "true" || s === "yes" || s === "1";
}

/** Canonical tag key (normalize tags for matching) */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

/** URL slug for the route param */
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/** Display label */
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w[0].toUpperCase() + w.slice(1) : w))
    .join(" ");
}

/** Build-safe date getter */
function getPostDate(post) {
  const d =
    post?.data?.date ??
    post?.data?.pubDate ??
    post?.data?.published ??
    post?.data?.updated ??
    null;

  const dt = d ? new Date(d) : null;
  return dt && !Number.isNaN(dt.getTime()) ? dt : null;
}

const all = await getCollection("posts");

const posts = all
  .filter(isDaytonaPost)
  .sort((a, b) => {
    const da = getPostDate(a)?.getTime() ?? 0;
    const db = getPostDate(b)?.getTime() ?? 0;
    return db - da;
  });

const title = "Latest Posts";
---

<Base title={`${title} | GoDo Daytona`} description="Latest GoDo Daytona posts.">
  <main class="container">
    <header class="page-header">
      <p class="kicker"><a href="/daytona/">GoDo Daytona</a> / Posts</p>
      <h1>{title}</h1>
      <p class="meta">{posts.length} total</p>
    </header>

    <ul class="post-list">
      {posts.map((p) => {
        const d = getPostDate(p);
        const dateText = d
          ? d.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })
          : "";

        // IMPORTANT: use slug, NOT id (id may contain ".md")
        const href = `/daytona/posts/${p.slug}/`;

        const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
        const tagKeys = Array.from(new Set(rawTags.map(tagKey).filter(Boolean)));
        const tagItems = tagKeys.map((k) => ({
          key: k,
          label: tagLabelFromKey(k),
          slug: tagSlugFromKey(k),
        }));

        return (
          <li class="post-item">
            {/* Stretched link makes the whole card clickable without nesting anchors */}
            <a class="stretched-link" href={href} aria-label={`Open: ${p.data.title ?? p.slug}`} />

            <div class="post-top">
              <div class="post-title">{p.data.title ?? p.slug}</div>
              {isFeatured(p) ? <span class="featuredPill">FEATURED</span> : null}
            </div>

            <div class="metaRow">
              {dateText ? <span class="post-date">{dateText}</span> : null}

              {tagItems.length > 0 ? (
                <span class="tagRow" aria-label="Topics">
                  {tagItems.map((t) => (
                    <a class="topicPill" href={`/daytona/topic/${t.slug}/`}>{t.label}</a>
                  ))}
                </span>
              ) : null}
            </div>

            {p.data.description ? <p class="post-desc">{p.data.description}</p> : null}
          </li>
        );
      })}
    </ul>
  </main>

  <style>
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }

    .kicker { margin: 0 0 8px; opacity: 0.8; }
    .page-header h1 { margin: 0 0 8px; }
    .meta { margin: 0 0 24px; opacity: 0.8; }

    .post-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 14px; }

    .post-item {
      position: relative;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 14px 16px;
      background: rgba(255,255,255,0.02);
    }

    /* Whole-card link */
    .stretched-link {
      position: absolute;
      inset: 0;
      border-radius: 14px;
      z-index: 1;
      text-decoration: none;
    }

    /* Keep real interactive elements ABOVE stretched link */
    .post-top, .metaRow, .post-desc { position: relative; z-index: 2; }

    .post-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    /* ~15% larger */
    .post-title { font-weight: 900; font-size: 18.5px; line-height: 1.2; }

    .metaRow {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      opacity: 0.78;
    }

    .post-date { white-space: nowrap; }

    /* Description clamp (2 lines) */
    .post-desc {
      margin: 8px 0 0;
      opacity: 0.85;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .tagRow { display: inline-flex; flex-wrap: wrap; gap: 8px; }

    /* Smaller + faded yellow ~30% */
    .topicPill {
      display: inline-flex;
      align-items: center;
      justify-content: center;

      padding: 5px 9px;              /* smaller */
      border-radius: 999px;
      font-size: 11.5px;             /* smaller */
      font-weight: 900;
      letter-spacing: .02em;
      text-decoration: none;

      color: rgba(17,17,17,0.95);
      background: rgba(255, 220, 80, 0.65); /* faded */
      border: 1px solid rgba(255, 220, 80, 0.55);

      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
    }

    .topicPill:hover { transform: translateY(-1px); filter: brightness(1.03); }
    .topicPill:active { transform: translateY(0px); opacity: .92; }

    .featuredPill {
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .04em;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,220,80,.55);
      color: rgba(255,220,80,.95);
      background: rgba(255,220,80,.10);
      white-space: nowrap;
    }
  </style>
</Base>
