---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona-only filter
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/**
 * Canonical tag key
 * Makes "Motor Sports" == "motor-sports"
 */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

/**
 * Slug for URL
 */
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/**
 * Pretty label
 */
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

/**
 * Safe date getter
 */
function getPostDate(post) {
  const d =
    post?.data?.pubDate ??
    post?.data?.date ??
    post?.data?.published ??
    post?.data?.updated ??
    null;

  const dt = d ? new Date(d) : null;
  return dt && !Number.isNaN(dt.getTime()) ? dt : null;
}

/**
 * Sort newest first
 */
function sortNewestFirst(a, b) {
  return (getPostDate(b)?.getTime() ?? 0) - (getPostDate(a)?.getTime() ?? 0);
}

const all = await getCollection("posts");

const posts = all
  .filter(isDaytonaPost)
  .sort(sortNewestFirst);

const title = "Posts";
---

<Base
  title={`${title} | GoDo Daytona`}
  description="Latest GoDo Daytona posts"
>
  <main class="container">
    <header class="page-header">
      <p class="kicker">
        <a href="/daytona/">GoDo Daytona</a> / Posts
      </p>
      <h1>Latest Posts</h1>
      <p class="meta">{posts.length} total</p>
    </header>

    {posts.length === 0 ? (
      <p>No posts yet.</p>
    ) : (
      <ul class="post-list">
        {posts.map((p) => {
          const d = getPostDate(p);
          const dateText = d
            ? d.toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
            : "";

          // Tags for this post
          const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
          const tagKeys = Array.from(
            new Set(rawTags.map(tagKey).filter(Boolean))
          );

          const tagLinks = tagKeys.map((k) => ({
            label: tagLabelFromKey(k),
            slug: tagSlugFromKey(k),
          }));

          return (
            <li class="post-card">
              <a class="post-link" href={`/daytona/posts/${p.slug}/`}>
                <div class="post-title">{p.data.title}</div>
                {p.data.description && (
                  <div class="post-desc">{p.data.description}</div>
                )}
                {dateText && <div class="post-date">{dateText}</div>}
              </a>

              {/* ✅ Topic links under the post */}
              {tagLinks.length > 0 && (
                <div class="post-tags">
                  {tagLinks.map((t, i) => (
                    <>
                      <a class="tag-pill" href={`/daytona/topic/${t.slug}/`}>
                        {t.label}
                      </a>
                      {i < tagLinks.length - 1 && (
                        <span class="dot">·</span>
                      )}
                    </>
                  ))}
                </div>
              )}
            </li>
          );
        })}
      </ul>
    )}
  </main>

  <style>
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }

    .kicker {
      margin: 0 0 8px;
      opacity: 0.8;
    }

    .meta {
      opacity: 0.75;
      margin-bottom: 22px;
    }

    .post-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 16px;
    }

    .post-card {
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.02);
    }

    .post-link {
      text-decoration: none;
      display: block;
    }

    .post-title {
      font-weight: 800;
      font-size: 18px;
      margin-bottom: 6px;
    }

    .post-desc {
      opacity: 0.85;
      margin-bottom: 8px;
    }

    .post-date {
      opacity: 0.6;
      font-size: 0.95em;
    }

    /* ✅ Tag row */
    .post-tags {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 13px;
      opacity: 0.9;
    }

    .tag-pill {
      text-decoration: none;
      font-weight: 600;
      opacity: 0.85;
    }

    .tag-pill:hover {
      opacity: 1;
      text-decoration: underline;
    }

    .dot {
      opacity: 0.5;
      padding: 0 4px;
    }
  </style>
</Base>
