---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/** Daytona filter (supports frontmatter city and legacy folder IDs) */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/** Canonical tag key */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

/** URL slug from canonical key */
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/** Display label */
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : ""))
    .join(" ");
}

/** Build-safe date getter */
function getPostDate(post) {
  const d =
    post?.data?.date ??
    post?.data?.pubDate ??
    post?.data?.published ??
    post?.data?.updated ??
    null;

  const dt = d ? new Date(d) : null;
  return dt && !Number.isNaN(dt.getTime()) ? dt : null;
}

const posts = (await getCollection("posts"))
  .filter(isDaytonaPost)
  .sort((a, b) => {
    const da = getPostDate(a)?.getTime() ?? 0;
    const db = getPostDate(b)?.getTime() ?? 0;
    return db - da;
  });

const title = "Latest Posts";
---

<Base title={`${title} | GoDo Daytona`} description="Latest GoDo Daytona posts.">
  <main class="container">
    <header class="page-header">
      <p class="kicker"><a href="/daytona/">GoDo Daytona</a> / Posts</p>
      <h1>{title}</h1>
      <p class="meta">{posts.length} total</p>
    </header>

    <ul class="post-list">
      {posts.map((p) => {
        const d = getPostDate(p);
        const dateText = d
          ? d.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })
          : "";

        // tags -> yellow pills
        const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
        const uniqueKeys = Array.from(new Set(rawTags.map(tagKey).filter(Boolean)));
        const tagItems = uniqueKeys.map((key) => ({
          key,
          slug: tagSlugFromKey(key),
          label: tagLabelFromKey(key),
        }));

        return (
          <li class="post-item">
            <a class="post-link" href={`/daytona/posts/${p.slug}/`}>
              <div class="post-title">{p.data.title}</div>
              {p.data.description ? <div class="post-desc">{p.data.description}</div> : null}
              {dateText ? <div class="post-date">{dateText}</div> : null}
            </a>

            {tagItems.length > 0 ? (
              <div class="tagRow">
                {tagItems.map((t) => (
                  <a class="topicPill" href={`/daytona/topic/${t.slug}/`}>{t.label}</a>
                ))}
              </div>
            ) : null}
          </li>
        );
      })}
    </ul>
  </main>

  <style>
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    .kicker { margin: 0 0 8px; opacity: 0.8; }
    .page-header h1 { margin: 0 0 8px; }
    .meta { margin: 0 0 24px; opacity: 0.8; }

    .post-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 14px; }
    .post-item { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px 16px; }

    .post-link { display: block; text-decoration: none; }
    .post-title { font-weight: 800; font-size: 16px; }
    .post-desc { margin-top: 6px; opacity: 0.85; }
    .post-date { margin-top: 10px; opacity: 0.65; font-size: 0.95em; }

    .tagRow { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 10px; }

    /* Yellow rounded topic pills (Subscribe vibe) */
    .topicPill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .02em;
      text-decoration: none;

      color: #111;
      background: rgba(255, 220, 80, 0.95);
      border: 1px solid rgba(255, 220, 80, 0.95);

      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
    }

    .topicPill:hover { transform: translateY(-1px); filter: brightness(1.02); }
    .topicPill:active { transform: translateY(0px); opacity: .92; }
  </style>
</Base>
