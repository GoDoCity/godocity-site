---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona filter (supports frontmatter city + legacy folder IDs)
 * Build-safe: defined locally in this file.
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/** Featured flag normalization */
function isFeatured(post) {
  const v = post?.data?.featured;
  if (v === true) return true;
  if (v === 1) return true;
  const s = String(v ?? "").toLowerCase().trim();
  return s === "true" || s === "yes" || s === "1";
}

/** Build-safe date getter */
function getPostDate(post) {
  const d =
    post?.data?.pubDate ??
    post?.data?.date ??
    post?.data?.published ??
    post?.data?.updated ??
    null;

  const dt = d ? new Date(d) : null;
  return dt && !Number.isNaN(dt.getTime()) ? dt : null;
}

/** Canonical tag key (normalize tags for matching) */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

/** URL slug for topic route */
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/** Display label */
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w[0].toUpperCase() + w.slice(1) : w))
    .join(" ");
}

/** Sort newest first */
function sortNewestFirst(a, b) {
  const da = getPostDate(a)?.getTime() ?? 0;
  const db = getPostDate(b)?.getTime() ?? 0;
  return db - da;
}

const all = await getCollection("posts");
const posts = all.filter(isDaytonaPost).sort(sortNewestFirst);

const title = "Latest Posts";
const pageTitle = `${title} | GoDo Daytona`;
const description = "The latest GoDo Daytona posts.";
---

<Base title={pageTitle} description={description}>
  <main class="container">
    <header class="page-header">
      <p class="kicker"><a href="/daytona/">GoDo Daytona</a> / Posts</p>
      <h1>{title}</h1>
      <p class="meta">{posts.length} total</p>
    </header>

    {posts.length === 0 ? (
      <p>No posts yet.</p>
    ) : (
      <ul class="post-list">
        {posts.map((p) => {
          const d = getPostDate(p);
          const dateText = d
            ? d.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })
            : "";

          const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
          const uniqueKeySet = new Set(rawTags.map(tagKey).filter(Boolean));
          const tagItems = Array.from(uniqueKeySet).map((k) => ({
            key: k,
            label: tagLabelFromKey(k),
            slug: tagSlugFromKey(k),
          }));

          // IMPORTANT: use p.id to support legacy folder IDs (daytona/...)
          const href = `/daytona/posts/${p.id}/`;

          return (
            <li class="post-item">
              {/* Card content (NOT a link) */}
              <div class="card">
                {/* The stretched link (only link inside the card for the post) */}
                <a class="stretched-link" href={href} aria-label={p.data.title ?? p.id}></a>

                <div class="cardTop">
                  <div class="post-title">{p.data.title ?? p.id}</div>

                  {isFeatured(p) && (
                    <span class="featuredPill">FEATURED</span>
                  )}
                </div>

                {/* Inline date + tags */}
                <div class="metaRow">
                  {dateText ? <span class="post-date">{dateText}</span> : null}

                  {tagItems.length ? (
                    <span class="tagInline">
                      {tagItems.map((t) => (
                        <a class="topicPill" href={`/daytona/topic/${t.slug}/`}>{t.label}</a>
                      ))}
                    </span>
                  ) : null}
                </div>

                {p.data.description ? <div class="post-desc clamp2">{p.data.description}</div> : null}
              </div>
            </li>
          );
        })}
      </ul>
    )}
  </main>

  <style>
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    .kicker { margin: 0 0 8px; opacity: 0.8; }
    .page-header h1 { margin: 0 0 8px; }
    .meta { margin: 0 0 24px; opacity: 0.8; }

    .post-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 14px; }

    .post-item { margin: 0; }

    .card{
      position: relative;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 16px 18px;
      background: rgba(255,255,255,0.02);
      overflow: hidden;
    }

    /* The “whole card clickable” link */
    .stretched-link{
      position: absolute;
      inset: 0;
      z-index: 1;
      border-radius: 12px;
      text-decoration: none;
    }

    /* Ensure real controls sit above stretched-link */
    .cardTop, .metaRow, .post-desc { position: relative; z-index: 2; }

    /* ~15% larger */
    .post-title { font-weight: 900; font-size: 19px; line-height: 1.25; }

    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }

    .metaRow{
      margin-top: 10px;
      display: flex;
      align-items: baseline;
      flex-wrap: wrap;
      gap: 10px;
      opacity: .78;
    }

    .post-date{
      font-size: .95em;
      opacity: .9;
      white-space: nowrap;
    }

    /* Tags line (no dots; cleaner on lists) */
    .tagInline{
      display: inline-flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: baseline;
    }

    /* Smaller + ~30% faded yellow */
    .topicPill{
      display:inline-flex;
      align-items:center;
      justify-content:center;

      padding: 4px 8px;
      border-radius: 999px;

      font-size: 11px;
      font-weight: 900;
      letter-spacing: .01em;

      text-decoration:none;
      color:#111;

      background: rgba(255, 220, 80, 0.65);
      border: 1px solid rgba(255, 220, 80, 0.55);

      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      position: relative;
      z-index: 3; /* above stretched link */
    }

    .topicPill:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    .topicPill:active{ transform: translateY(0px); opacity: .9; }

    .topicPill:focus-visible{
      outline: 2px solid rgba(255,220,80,.9);
      outline-offset: 2px;
    }

    /* Featured pill */
    .featuredPill{
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .04em;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,220,80,.65);
      color: rgba(255,220,80,.95);
      background: rgba(255,220,80,.12);
      white-space: nowrap;
      position: relative;
      z-index: 3; /* above stretched link */
    }

    /* 2-line clamp */
    .clamp2{
      margin-top: 8px;
      opacity: 0.85;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</Base>
