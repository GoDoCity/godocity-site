---
import Base from "../../../../layouts/Base.astro";
import { getCollection } from "astro:content";

function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

function isFeatured(post) {
  const v = post?.data?.featured;
  if (v === true) return true;
  if (v === 1) return true;
  const s = String(v ?? "").toLowerCase().trim();
  return s === "true" || s === "yes" || s === "1";
}

function getPostDate(post) {
  return (
    post?.data?.pubDate ??
    post?.data?.date ??
    post?.data?.published ??
    post?.data?.updated ??
    null
  );
}

function sortNewestFirst(a, b) {
  const da = new Date(getPostDate(a) ?? 0).getTime();
  const db = new Date(getPostDate(b) ?? 0).getTime();
  return db - da;
}

const all = await getCollection("posts");
const posts = all
  .filter(isDaytonaPost)
  .filter(isFeatured)
  .sort(sortNewestFirst);

const pageTitle = "Featured Posts";
const pageSubtitle = "Featured posts only.";
---

<Base title={pageTitle} subtitle={pageSubtitle} cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 980px;">
    <h1 class="h1">{pageTitle}</h1>
    <p class="lede">{pageSubtitle}</p>

    <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/posts/">All posts</a>
      <a class="pill" href="/daytona/posts/featured/">Featured</a>
    </div>

    <div style="margin-top:18px;display:flex;flex-direction:column;gap:14px;">
      {posts.map((p) => {
        const title = p.data.title ?? p.slug;
        const desc = p.data.description ?? "";
        const d = getPostDate(p);
        const dateText = d ? new Date(d).toLocaleDateString() : "";

        return (
          <a href={`/daytona/posts/${p.slug}/`} style="display:block;text-decoration:none;">
            <div
              style="
                border: 1px solid rgba(255,255,255,.12);
                border-radius: 14px;
                padding: 14px 16px;
                background: rgba(255,255,255,.03);
              "
            >
              <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
                <div>
                  <div style="font-weight:700;font-size:18px;line-height:1.25">{title}</div>
                  {desc && <div style="opacity:.8;margin-top:6px">{desc}</div>}
                  {dateText && <div style="opacity:.6;margin-top:8px">{dateText}</div>}
                </div>

                <span
                  style="
                    font-size: 12px;
                    font-weight: 800;
                    letter-spacing: .04em;
                    padding: 6px 10px;
                    border-radius: 999px;
                    border: 1px solid rgba(255,220,80,.65);
                    color: rgba(255,220,80,.95);
                    background: rgba(255,220,80,.12);
                    white-space: nowrap;
                  "
                >
                  FEATURED
                </span>
              </div>
            </div>
          </a>
        );
      })}
    </div>

    {posts.length === 0 && (
      <p style="margin-top:18px;opacity:.7">No featured posts yet.</p>
    )}

    <div style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/">‚Üê Daytona home</a>
      <a class="pill" href="/daytona/topics/">Topics</a>
    </div>
  </div>
</section>
