---
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona Home — polish
 * - Top Topics (counts, canonical slugs)
 * - Latest Posts
 * - Safe: no getStaticPaths changes
 */

// Rule A canonical key
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : ""))
    .join(" ");
}

function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

const allPosts = (await getCollection("posts")).filter(isDaytonaPost);

const latestPosts = allPosts
  .slice()
  .sort((a, b) => +new Date(b.data.pubDate) - +new Date(a.data.pubDate))
  .slice(0, 6);

// Build topic counts
const topicCounts = new Map(); // key -> count
for (const p of allPosts) {
  const tags = Array.isArray(p.data?.tags) ? p.data.tags : [];
  for (const raw of tags) {
    const key = tagKey(raw);
    if (!key) continue;
    topicCounts.set(key, (topicCounts.get(key) ?? 0) + 1);
  }
}

const topTopics = Array.from(topicCounts.entries())
  .map(([key, count]) => ({
    key,
    count,
    label: tagLabelFromKey(key),
    slug: tagSlugFromKey(key),
  }))
  .sort((a, b) => b.count - a.count || a.label.localeCompare(b.label))
  .slice(0, 10);

// Hero image for Daytona (already in your CSS vars)
const title = "GoDoDaytona";
const subtitle = "Local picks, events, guides, and stories — Daytona Beach & surrounding areas.";
---

<Base title={title} subtitle={subtitle} cityBase="daytona" />

<section class="hero has-hero-img">
  <div class="container">
    <div class="hero-grid">
      <div class="card card-pad">
        <div class="kicker">GoDoDaytona</div>
        <div class="h1">Your Daytona cheat code.</div>
        <p class="lede">
          Curated local stories, events, and guides — built fast, kept clean, and organized by Topics.
        </p>

        <div class="tagrow">
          <a class="tag" href="/daytona/topics/">Browse Topics</a>
          <a class="tag" href="/daytona/posts/">Latest Posts</a>
          <a class="tag" href="/daytona/subscribe/">Subscribe</a>
        </div>
      </div>

      <div class="card">
        <div class="article">
          <h3 style="margin:0 0 6px;">Top Topics</h3>
          <p style="margin:0;color:var(--muted);line-height:1.5;">
            The most active topics right now.
          </p>
        </div>

        <div class="article">
          {topTopics.length ? (
            <div style="display:flex;flex-wrap:wrap;gap:10px;">
              {topTopics.map((t) => (
                <a class="pill" href={`/daytona/topic/${t.slug}/`}>
                  {t.label} <span style="opacity:.65">({t.count})</span>
                </a>
              ))}
            </div>
          ) : (
            <p style="margin:0;color:var(--muted);">
              No topics yet — add tags to posts in Admin and they’ll appear here.
            </p>
          )}
        </div>
      </div>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div style="display:flex;align-items:baseline;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <h2 style="margin:0;font-size:22px;">Latest Posts</h2>
      <a class="pill" href="/daytona/posts/">View all</a>
    </div>

    <div class="grid" style="margin-top:14px;">
      {latestPosts.length ? (
        latestPosts.map((p) => (
          <a class="card" href={`/daytona/posts/${p.slug}/`} style="display:block;">
            <div class="card-pad">
              <div style="font-weight:900;font-size:18px;line-height:1.2;">
                {p.data.title}
              </div>
              {p.data.description && (
                <div style="opacity:.82;margin-top:6px;line-height:1.45;">
                  {p.data.description}
                </div>
              )}
              <div style="opacity:.6;margin-top:10px;font-size:13px;">
                {new Date(p.data.pubDate).toLocaleDateString()}
              </div>
            </div>
          </a>
        ))
      ) : (
        <div class="card card-pad">
          No posts yet. Create one in Admin and it will show up here.
        </div>
      )}
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="card card-pad">
      <h2 style="margin:0 0 8px 0;font-size:22px;">Get the weekly drop</h2>
      <p class="lede" style="margin:0 0 12px 0;">
        One email. The best of Daytona. No spam.
      </p>
      <form action="#" method="post">
        <input type="email" placeholder="Email address" aria-label="Email address" />
        <button class="cta" type="button">Subscribe</button>
      </form>
      <div class="note">
        (Form hookup later — this is placeholder UI so the site feels complete.)
      </div>
    </div>
  </div>
</section>
