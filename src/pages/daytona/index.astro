---
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona filter (supports both explicit frontmatter city and legacy folder IDs)
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/**
 * Featured flag normalization:
 * supports:
 *   featured: true
 *   featured: "true"
 *   featured: "yes"
 *   featured: 1
 *   featured: "1"
 */
function isFeatured(post) {
  const v = post?.data?.featured;
  if (v === true) return true;
  if (v === 1) return true;
  const s = String(v ?? "").toLowerCase().trim();
  return s === "true" || s === "yes" || s === "1";
}

/**
 * Safe date getter (fallback order)
 */
function getPostDate(post) {
  return (
    post?.data?.pubDate ??
    post?.data?.date ??
    post?.data?.published ??
    post?.data?.updated ??
    null
  );
}

/**
 * Sort newest first
 */
function sortNewestFirst(a, b) {
  const da = new Date(getPostDate(a) ?? 0).getTime();
  const db = new Date(getPostDate(b) ?? 0).getTime();
  return db - da;
}

// Load posts
const all = await getCollection("posts");

// Daytona only
const daytonaPosts = all.filter(isDaytonaPost).sort(sortNewestFirst);

// Featured only (top 3)
const featuredPosts = daytonaPosts.filter(isFeatured).slice(0, 3);

// Latest posts (top 5)
const latestPosts = daytonaPosts.slice(0, 5);
---

<Base
  title="GoDoDaytona"
  subtitle="GoDo386 • Local stories, guides, and what’s happening in Daytona Beach."
  cityBase="daytona"
/>

<section class="section">
  <div class="container" style="max-width: 980px;">
    <h1 class="h1">GoDoDaytona</h1>
    <p class="lede">GoDo386 • Local stories, guides, and what’s happening in Daytona Beach.</p>

    {featuredPosts.length > 0 && (
      <section style="margin-top:22px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
          <h2 style="margin:0;font-size:22px;font-weight:800;">Featured</h2>
          <a class="pill" href="/daytona/posts/?featured=1">View all featured</a>
        </div>

        <div style="margin-top:12px;display:flex;flex-direction:column;gap:14px;">
          {featuredPosts.map((p) => {
            const title = p.data.title ?? p.slug;
            const desc = p.data.description ?? "";
            const d = getPostDate(p);
            const dateText = d ? new Date(d).toLocaleDateString() : "";

            return (
              <a href={`/daytona/posts/${p.slug}/`} style="display:block;text-decoration:none;">
                <div
                  style="
                    border: 1px solid rgba(255,255,255,.12);
                    border-radius: 14px;
                    padding: 14px 16px;
                    background: rgba(255,255,255,.03);
                  "
                >
                  <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
                    <div>
                      <div style="font-weight:800;font-size:18px;line-height:1.25">{title}</div>
                      {desc && <div style="opacity:.8;margin-top:6px">{desc}</div>}
                      {dateText && <div style="opacity:.6;margin-top:8px">{dateText}</div>}
                    </div>

                    <span
                      style="
                        font-size: 12px;
                        font-weight: 800;
                        letter-spacing: .04em;
                        padding: 6px 10px;
                        border-radius: 999px;
                        border: 1px solid rgba(255,220,80,.65);
                        color: rgba(255,220,80,.95);
                        background: rgba(255,220,80,.12);
                        white-space: nowrap;
                      "
                    >
                      FEATURED
                    </span>
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    )}

    <section style="margin-top:26px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
        <h2 style="margin:0;font-size:22px;font-weight:800;">Latest</h2>
        <a class="pill" href="/daytona/posts/">All posts</a>
      </div>

      <div style="margin-top:12px;display:flex;flex-direction:column;gap:14px;">
        {latestPosts.map((p) => {
          const title = p.data.title ?? p.slug;
          const desc = p.data.description ?? "";
          const d = getPostDate(p);
          const dateText = d ? new Date(d).toLocaleDateString() : "";
          const featured = isFeatured(p);

          return (
            <a href={`/daytona/posts/${p.slug}/`} style="display:block;text-decoration:none;">
              <div
                style="
                  border: 1px solid rgba(255,255,255,.12);
                  border-radius: 14px;
                  padding: 14px 16px;
                  background: rgba(255,255,255,.03);
                "
              >
                <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
                  <div>
                    <div style="font-weight:800;font-size:18px;line-height:1.25">{title}</div>
                    {desc && <div style="opacity:.8;margin-top:6px">{desc}</div>}
                    {dateText && <div style="opacity:.6;margin-top:8px">{dateText}</div>}
                  </div>

                  {featured && (
                    <span
                      style="
                        font-size: 12px;
                        font-weight: 800;
                        letter-spacing: .04em;
                        padding: 6px 10px;
                        border-radius: 999px;
                        border: 1px solid rgba(255,220,80,.65);
                        color: rgba(255,220,80,.95);
                        background: rgba(255,220,80,.12);
                        white-space: nowrap;
                      "
                    >
                      FEATURED
                    </span>
                  )}
                </div>
              </div>
            </a>
          );
        })}
      </div>
    </section>

    <div style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/topics/">Topics</a>
      <a class="pill" href="/daytona/posts/?featured=1">Featured</a>
    </div>
  </div>
</section>
