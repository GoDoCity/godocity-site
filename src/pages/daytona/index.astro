---
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";

// Load all posts, then keep only Daytona posts (supports a few common field names)
const all = await getCollection("posts");

// Normalize city field (some of your content/config uses `city`)
const daytonaPosts = all
  .filter((p) => {
    const city =
      (p.data?.city ?? p.data?.cityBase ?? p.data?.location ?? "").toString().toLowerCase();
    return city === "daytona";
  })
  .sort((a, b) => {
    const da = new Date(a.data?.pubDate ?? a.data?.date ?? 0).getTime();
    const db = new Date(b.data?.pubDate ?? b.data?.date ?? 0).getTime();
    return db - da;
  });

// Pick a featured post if one is marked, otherwise the newest post
const featured =
  daytonaPosts.find((p) => p?.data?.featured === true) ?? daytonaPosts[0] ?? null;

// Latest list (excluding featured)
const latest = (daytonaPosts ?? [])
  .filter((p) => p?.id && p.id !== featured?.id)
  .slice(0, 5);

// Helpers
const postUrl = (p) => `/daytona/posts/${p.slug}/`;
const postDescription = (p) =>
  p?.data?.description ??
  p?.data?.excerpt ??
  p?.data?.summary ??
  "";
const postTitle = (p) => p?.data?.title ?? "Untitled";
const postTags = (p) =>
  (p?.data?.tags ?? p?.data?.topics ?? p?.data?.topic ?? []).filter(Boolean);

const formatDate = (d) => {
  if (!d) return "";
  try {
    return new Date(d).toLocaleDateString(undefined, {
      year: "numeric",
      month: "short",
      day: "numeric",
    });
  } catch {
    return "";
  }
};
---

<Base
  title="GoDoDaytona"
  subtitle="GoDo386 • Local stories, guides, and what’s happening in Daytona Beach."
  cityBase="daytona"
>
  <!-- Postcard banner (image only, no interference with content) -->
  <header class="city-banner" aria-label="Greetings from Daytona Beach"></header>

  <!-- Hero content -->
  <section class="hero hero-daytona">
    <div class="container hero-grid">
      <!-- Featured -->
      <article class="card card-pad">
        <div class="kicker">Featured</div>

        {featured ? (
          <>
            <h1 class="h1" style="font-size:40px;margin-bottom:8px">
              <a href={postUrl(featured)} style="text-decoration:none;color:inherit">
                {postTitle(featured)}
              </a>
            </h1>

            {postDescription(featured) ? (
              <p class="lede">{postDescription(featured)}</p>
            ) : (
              <p class="lede">New story coming soon.</p>
            )}

            <div class="tagrow">
              {(postTags(featured) ?? []).slice(0, 5).map((t) => (
                <a class="tag" href={`/daytona/topic/${t}/`}>{t}</a>
              ))}
            </div>

            <div style="margin-top:14px">
              <a class="cta" href={postUrl(featured)}>Read</a>
            </div>
          </>
        ) : (
          <>
            <h1 class="h1" style="font-size:40px;margin-bottom:8px">GoDoDaytona</h1>
            <p class="lede">No posts yet. Click “New Posts” in the admin to add your first one.</p>
          </>
        )}
      </article>

      <!-- Latest -->
      <aside class="card card-pad">
        <div class="kicker">Latest</div>

        {latest.length ? (
          <ul class="list" style="list-style:none;padding:0;margin:10px 0 0 0;display:grid;gap:10px">
            {latest.map((p) => (
              <li class="row" style="display:grid;gap:4px">
                <div style="display:flex;gap:10px;align-items:baseline;flex-wrap:wrap">
                  <a class="h3" href={postUrl(p)} style="text-decoration:none">
                    {postTitle(p)}
                  </a>
                  <span style="opacity:.7;font-size:13px">
                    {formatDate(p.data?.pubDate ?? p.data?.date)}
                  </span>
                </div>

                {postDescription(p) ? (
                  <p style="margin:0;opacity:.85">{postDescription(p)}</p>
                ) : null}

                <div class="tagrow">
                  {(postTags(p) ?? []).slice(0, 3).map((t) => (
                    <a class="tag" href={`/daytona/topic/${t}/`}>{t}</a>
                  ))}
                </div>
              </li>
            ))}
          </ul>
        ) : (
          <p class="lede" style="margin-top:10px">Nothing yet — add your first post in Admin.</p>
        )}

        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
          <a class="pill" href="/daytona/posts/">All posts</a>
          <a class="pill" href="/daytona/guides/">Guides</a>
          <a class="pill" href="/daytona/events/">Events</a>
        </div>
      </aside>
    </div>
  </section>
</Base>


