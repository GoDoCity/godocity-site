---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/** Build-safe date getter */
function getPostDate(post) {
  const d =
    post?.data?.date ??
    post?.data?.pubDate ??
    post?.data?.published ??
    post?.data?.updated ??
    null;

  const dt = d ? new Date(d) : null;
  return dt && !Number.isNaN(dt.getTime()) ? dt : null;
}

/** Display label */
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "Topic";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w[0].toUpperCase() + w.slice(1) : w))
    .join(" ");
}

/**
 * Static paths: build all /daytona/topic/<tag> pages
 * EVERYTHING used here is defined INSIDE this function (build-proof).
 */
export async function getStaticPaths() {
  // helpers must be local to guarantee scope in Cloudflare/Astro build
  const isDaytonaPost = (post) => {
    const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
    if (city === "daytona") return true;
    return typeof post?.id === "string" && post.id.startsWith("daytona/");
  };

  const tagKey = (raw) => {
    return String(raw ?? "")
      .toLowerCase()
      .trim()
      .replace(/[-_]+/g, " ")
      .replace(/\s+/g, " ");
  };

  const tagSlugFromKey = (key) => {
    return String(key ?? "")
      .toLowerCase()
      .trim()
      .replace(/&/g, "and")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "");
  };

  const all = await getCollection("posts");
  const daytonaPosts = all.filter(isDaytonaPost);

  const keys = new Set();
  for (const p of daytonaPosts) {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    for (const t of rawTags) {
      const k = tagKey(t);
      if (k) keys.add(k);
    }
  }

  return Array.from(keys)
    .sort((a, b) => a.localeCompare(b))
    .map((k) => ({
      params: { tag: tagSlugFromKey(k) },
      props: { tagKeyValue: k },
    }));
}

const { tagKeyValue } = Astro.props;

// page-level helpers (can be outside; only getStaticPaths was failing scope)
const isDaytonaPost = (post) => {
  const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
};

const tagKey = (raw) => {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
};

// Load posts for this topic page (Daytona-only, matching canonical key)
const posts = (await getCollection("posts"))
  .filter(isDaytonaPost)
  .filter((p) => {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    return rawTags.map(tagKey).includes(tagKeyValue);
  })
  .sort((a, b) => {
    const da = getPostDate(a)?.getTime() ?? 0;
    const db = getPostDate(b)?.getTime() ?? 0;
    return db - da;
  });

const title = tagLabelFromKey(tagKeyValue);
---

<Base
  title={`${title} | GoDo Daytona`}
  description={`GoDo Daytona posts tagged "${title}".`}
>
  <main class="container">
    <header class="topic-header">
      <p class="kicker"><a href="/daytona/">GoDo Daytona</a> / Topic</p>
      <h1>{title}</h1>
      <p class="meta">{posts.length} post{posts.length === 1 ? "" : "s"}</p>
    </header>

    {posts.length === 0 ? (
      <p>No posts found for this topic.</p>
    ) : (
      <ul class="topic-list">
        {posts.map((p) => {
          const d = getPostDate(p);
          const dateText = d
            ? d.toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })
            : "";
          const href = `/daytona/posts/${p.id}/`;
          return (
            <li class="topic-item">
              <a class="topic-link" href={href}>
                <span class="topic-title">{p.data.title}</span>
                {dateText ? <span class="topic-date">{dateText}</span> : null}
              </a>
              {p.data.description ? (
                <p class="topic-desc">{p.data.description}</p>
              ) : null}
            </li>
          );
        })}
      </ul>
    )}
  </main>

  <style>
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    .kicker { margin: 0 0 8px; opacity: 0.8; }
    .topic-header h1 { margin: 0 0 8px; }
    .meta { margin: 0 0 24px; opacity: 0.8; }
    .topic-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 14px; }
    .topic-item { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px 16px; }
    .topic-link { display: flex; justify-content: space-between; gap: 12px; align-items: baseline; }
    .topic-title { font-weight: 700; }
    .topic-date { opacity: 0.75; font-size: 0.95em; white-space: nowrap; }
    .topic-desc { margin: 8px 0 0; opacity: 0.85; }
  </style>
</Base>
