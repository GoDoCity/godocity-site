---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona filter (supports both explicit frontmatter city and legacy folder IDs)
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/**
 * Canonical Tag Normalization (build-safe)
 * - case-insensitive
 * - treats "motor sports", "motor-sports", "Motor Sports" as the same tag
 */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : ""))
    .join(" ");
}

/**
 * Safe date getter (fallback order)
 */
function getPostDate(post) {
  return (
    post?.data?.pubDate ??
    post?.data?.date ??
    post?.data?.published ??
    post?.data?.updated ??
    null
  );
}

/**
 * Sort newest first
 */
function sortNewestFirst(a, b) {
  const da = new Date(getPostDate(a) ?? 0).getTime();
  const db = new Date(getPostDate(b) ?? 0).getTime();
  return db - da;
}

/**
 * Build Topic Map: { key -> { key, slug, label, count } }
 */
function buildTopicItems(posts) {
  const map = new Map();

  for (const post of posts) {
    const raw = Array.isArray(post?.data?.tags) ? post.data.tags : [];
    const keys = Array.from(new Set(raw.map(tagKey).filter(Boolean))); // de-dupe within post

    for (const k of keys) {
      if (!map.has(k)) {
        map.set(k, {
          key: k,
          slug: tagSlugFromKey(k),
          label: tagLabelFromKey(k),
          count: 0,
          latestTs: 0,
        });
      }
      const item = map.get(k);
      item.count += 1;

      const ts = new Date(getPostDate(post) ?? 0).getTime();
      if (ts > item.latestTs) item.latestTs = ts;
    }
  }

  // Sort: most recent activity first, then count, then alpha
  const items = Array.from(map.values());
  items.sort((a, b) => {
    if (b.latestTs !== a.latestTs) return b.latestTs - a.latestTs;
    if (b.count !== a.count) return b.count - a.count;
    return a.label.localeCompare(b.label);
  });

  return items;
}

const all = await getCollection("posts");
const daytonaPosts = all.filter(isDaytonaPost).sort(sortNewestFirst);
const topics = buildTopicItems(daytonaPosts);

const title = "Topics";
const subtitle = "Browse posts by topic";
---

<Base title={title} subtitle={subtitle} cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 980px;">
    <div style="margin-bottom: 8px;">
      <div style="opacity:.7;font-weight:800;letter-spacing:.08em;font-size:12px;">GODO DAYTONA / TOPICS</div>
      <h1 class="h1" style="margin-top:8px;">Topics</h1>
      <div style="opacity:.7;margin-top:6px;">
        {topics.length} total
      </div>
    </div>

    {topics.length > 0 ? (
      <div class="topicGrid" aria-label="Topics">
        {topics.map((t) => (
          <a class="topicPill" href={`/daytona/topic/${t.slug}/`}>
            <span class="topicLabel">{t.label}</span>
            <span class="topicCount">{t.count}</span>
          </a>
        ))}
      </div>
    ) : (
      <div style="opacity:.75;margin-top:14px;">
        No topics yet. Add <code>tags</code> to a post’s frontmatter to populate this page.
      </div>
    )}

    <p style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/posts/">← Posts</a>
      <a class="pill" href="/daytona/">Home</a>
    </p>
  </div>
</section>

<style>
  /* Responsive pill grid */
  .topicGrid {
    margin-top: 14px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  /* Faded yellow pills (small) */
  .topicPill {
    display: inline-flex;
    align-items: center;
    gap: 8px;

    padding: 6px 10px;
    border-radius: 999px;

    text-decoration: none;
    cursor: pointer;

    /* ~30% faded vs solid */
    background: rgba(255, 220, 80, 0.65);
    border: 1px solid rgba(255, 220, 80, 0.55);
    color: #111;

    transition: transform 0.08s ease, filter 0.12s ease, opacity 0.12s ease;
  }

  .topicPill:hover {
    transform: translateY(-1px);
    filter: brightness(1.03);
  }

  .topicPill:active {
    transform: translateY(0px);
    opacity: 0.92;
  }

  .topicLabel {
    font-size: 12px;
    font-weight: 900;
    letter-spacing: 0.02em;
    line-height: 1;
  }

  .topicCount {
    font-size: 11px;
    font-weight: 900;
    line-height: 1;

    padding: 4px 7px;
    border-radius: 999px;

    background: rgba(17, 17, 17, 0.14);
    border: 1px solid rgba(17, 17, 17, 0.12);
  }
</style>
