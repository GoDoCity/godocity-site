---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona Topics Index
 * - Lists all unique tags found on Daytona posts
 * - Uses Rule A canonicalization so:
 *   "motor sports", "motor-sports", "Motor Sports" all become ONE topic: "Motor Sports"
 */

// Rule A canonical key for grouping
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

// URL slug from canonical key (matches [tag].astro route)
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

// Display label from canonical key (Title Case)
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : ""))
    .join(" ");
}

// Daytona filter (supports explicit city and legacy folder IDs)
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

const posts = (await getCollection("posts")).filter(isDaytonaPost);

// Build canonical tag map: key -> { label, slug }
const map = new Map();

for (const post of posts) {
  const rawTags = Array.isArray(post.data?.tags) ? post.data.tags : [];
  for (const raw of rawTags) {
    const key = tagKey(raw);
    if (!key) continue;

    if (!map.has(key)) {
      map.set(key, {
        key,
        label: tagLabelFromKey(key),
        slug: tagSlugFromKey(key),
      });
    }
  }
}

const topics = Array.from(map.values()).sort((a, b) =>
  a.label.localeCompare(b.label)
);
---

<Base title="Topics" subtitle="Browse posts by topic." cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 980px;">
    <h1 class="h1">Topics</h1>
    <p class="lede" style="opacity:.8">Browse posts by topic.</p>

    {topics.length === 0 ? (
      <div class="card" style="margin-top:18px;padding:18px;">
        <strong>NO TOPICS YET</strong>
        <div style="opacity:.8;margin-top:6px;">
          Add tags to posts and they will appear here automatically.
        </div>
      </div>
    ) : (
      <div style="margin-top:18px;display:flex;flex-wrap:wrap;gap:10px;">
        {topics.map((t) => (
          <a class="pill" href={`/daytona/topic/${t.slug}/`}>{t.label}</a>
        ))}
      </div>
    )}

    <p style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/">‚Üê Daytona home</a>
      <a class="pill" href="/daytona/posts/">All posts</a>
    </p>
  </div>
</section>
