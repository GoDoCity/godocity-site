---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

function cityOf(p) {
  // Prefer explicit frontmatter
  if (p.data?.city) return String(p.data.city).toLowerCase();

  // If legacy folder structure is used, infer city from id like "daytona/xxxx.md"
  if (typeof p.id === "string" && p.id.startsWith("daytona/")) return "daytona";

  // Default
  return "daytona";
}

function normalizeTag(t) {
  return String(t ?? "")
    .trim()
    .replace(/\s+/g, " ");
}

const posts = (await getCollection("posts"))
  .filter((p) => cityOf(p) === "daytona");

const tagSet = new Set();
for (const p of posts) {
  const tags = Array.isArray(p.data?.tags) ? p.data.tags : [];
  for (const t of tags) {
    const clean = normalizeTag(t);
    if (clean) tagSet.add(clean);
  }
}

const tags = Array.from(tagSet).sort((a, b) => a.localeCompare(b));
---

<Base title="Topics" subtitle="Browse posts by topic." cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 980px;">
    <h1 class="h1">Topics</h1>
    <p class="lede" style="opacity:.8">Browse posts by topic.</p>

    {tags.length === 0 ? (
      <div class="card" style="margin-top:18px;padding:18px;">
        <strong>NO TOPICS YET</strong>
        <div style="opacity:.8;margin-top:6px;">
          Add tags to posts in Admin and they will appear here automatically.
        </div>
      </div>
    ) : (
      <div style="margin-top:18px;display:flex;flex-wrap:wrap;gap:10px;">
        {tags.map((t) => (
          <a class="pill" href={`/daytona/topic/${encodeURIComponent(t)}/`}>
            {t}
          </a>
        ))}
      </div>
    )}

    <p style="margin-top:22px">
      <a class="pill" href="/daytona/">‚Üê Back to Daytona</a>
    </p>
  </div>
</section>
