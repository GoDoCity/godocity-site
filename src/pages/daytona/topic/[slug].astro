---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Helpers (safe to use in page render)
 */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : ""))
    .join(" ");
}

function getPostDate(post) {
  return (
    post?.data?.pubDate ??
    post?.data?.date ??
    post?.data?.published ??
    post?.data?.updated ??
    null
  );
}

function sortNewestFirst(a, b) {
  const da = new Date(getPostDate(a) ?? 0).getTime();
  const db = new Date(getPostDate(b) ?? 0).getTime();
  return db - da;
}

/**
 * ✅ getStaticPaths — SUPER BUILD-SAFE
 * No helper references whatsoever inside this function.
 */
export async function getStaticPaths() {
  const posts = await getCollection("posts");

  // Daytona-only (inline filter)
  const daytonaPosts = posts.filter((post) => {
    const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
    if (city === "daytona") return true;
    return typeof post?.id === "string" && post.id.startsWith("daytona/");
  });

  // tagKey inline (DO NOT reference outer tagKey)
  const localTagKey = (raw) =>
    String(raw ?? "")
      .toLowerCase()
      .trim()
      .replace(/[-_]+/g, " ")
      .replace(/\s+/g, " ");

  // slugify inline (DO NOT reference outer tagSlugFromKey)
  const localSlug = (key) =>
    String(key ?? "")
      .toLowerCase()
      .trim()
      .replace(/&/g, "and")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "");

  const keySet = new Set();

  for (const p of daytonaPosts) {
    const raw = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    for (const t of raw) {
      const k = localTagKey(t);
      if (k) keySet.add(k);
    }
  }

  const keys = Array.from(keySet).sort((a, b) => a.localeCompare(b));

  return keys.map((key) => ({
    params: { slug: localSlug(key) },
    props: { key },
  }));
}

/**
 * Page data
 */
const { key } = Astro.props;

const all = await getCollection("posts");
const daytonaPosts = all
  .filter((post) => {
    const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
    if (city === "daytona") return true;
    return typeof post?.id === "string" && post.id.startsWith("daytona/");
  })
  .sort(sortNewestFirst);

const topicKey = String(key ?? "").trim();
const topicSlug = tagSlugFromKey(topicKey);
const topicLabel = tagLabelFromKey(topicKey);

const postsForTopic = daytonaPosts.filter((p) => {
  const raw = Array.isArray(p?.data?.tags) ? p.data.tags : [];
  const keys = raw.map(tagKey).filter(Boolean);
  return keys.includes(topicKey);
});

const title = topicLabel || "Topic";
const subtitle = `${postsForTopic.length} post${postsForTopic.length === 1 ? "" : "s"}`;
---

<Base title={title} subtitle={subtitle} cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 860px;">
    <p class="crumb">
      <a href="/daytona/topics/">Topics</a>
      <span class="sep">/</span>
      <span>{topicLabel}</span>
    </p>

    <h1 class="h1">{topicLabel}</h1>
    <p class="lede" style="opacity:.75;margin-top:8px;">
      {postsForTopic.length} post{postsForTopic.length === 1 ? "" : "s"} tagged “{topicLabel}”
    </p>

    {postsForTopic.length === 0 ? (
      <div class="empty">
        <p style="margin:0;">No posts found for this topic.</p>
      </div>
    ) : (
      <ul class="postList">
        {postsForTopic.map((p) => {
          const t = p.data.title ?? p.slug;
          const desc = p.data.description ?? "";
          const d = getPostDate(p);
          const dateText = d ? new Date(d).toLocaleDateString("en-US") : "";

          return (
            <li class="postItem">
              {/* whole card clickable */}
              <a class="stretched" href={`/daytona/posts/${p.slug}/`} aria-label={t}></a>

              <div class="postTitle">{t}</div>

              {desc && <div class="postDesc">{desc}</div>}

              <div class="metaRow">
                {dateText && <span class="postDate">{dateText}</span>}
                {/* topic pill stays clickable */}
                <a class="topicPill" href={`/daytona/topic/${topicSlug}/`}>{topicLabel}</a>
              </div>
            </li>
          );
        })}
      </ul>
    )}

    <p style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/posts/">← All posts</a>
      <a class="pill" href="/daytona/topics/">All topics</a>
    </p>
  </div>
</section>

<style>
  .crumb {
    margin: 0 0 10px 0;
    opacity: .75;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    font-size: 13px;
  }
  .crumb a { text-decoration: none; }
  .sep { opacity: .5; }

  .empty {
    margin-top: 16px;
    padding: 16px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    opacity: .9;
  }

  .postList {
    list-style: none;
    padding: 0;
    margin: 18px 0 0 0;
    display: grid;
    gap: 14px;
  }

  .postItem {
    position: relative;
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    padding: 14px 16px;
    background: rgba(255,255,255,.03);
    cursor: pointer;
  }

  /* whole card clickable without breaking pill clicks */
  .stretched {
    position: absolute;
    inset: 0;
    border-radius: 14px;
    z-index: 1;
  }
  .postItem a.topicPill,
  .postTitle,
  .postDesc,
  .metaRow {
    position: relative;
    z-index: 2;
  }

  .postTitle {
    font-weight: 900;
    font-size: 18px;
    line-height: 1.25;
  }

  .postDesc {
    margin-top: 6px;
    opacity: .85;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .metaRow {
    margin-top: 10px;
    display: inline-flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    opacity: .72;
  }

  .postDate {
    font-size: 0.95em;
  }

  /* Smaller + faded yellow pill */
  .topicPill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 5px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 900;
    letter-spacing: .02em;
    text-decoration: none;

    color: #111;
    background: rgba(255, 220, 80, 0.65);
    border: 1px solid rgba(255, 220, 80, 0.55);
  }

  .topicPill:hover {
    background: rgba(255, 220, 80, 0.75);
    border-color: rgba(255, 220, 80, 0.70);
  }
</style>
