---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona filter (supports both explicit frontmatter city and legacy folder IDs)
 * Keep in SAME frontmatter as getStaticPaths.
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase().trim();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/**
 * Canonical Tag Normalization
 * - case-insensitive
 * - treats "motor sports", "motor-sports", "Motor_Sports" as the same
 */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

// URL slug from canonical key (stable)
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

// Display label from canonical key (Title Case)
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : ""))
    .join(" ");
}

function getPostDate(post) {
  return (
    post?.data?.pubDate ??
    post?.data?.date ??
    post?.data?.published ??
    post?.data?.updated ??
    null
  );
}

function sortNewestFirst(a, b) {
  const da = new Date(getPostDate(a) ?? 0).getTime();
  const db = new Date(getPostDate(b) ?? 0).getTime();
  return db - da;
}

/**
 * Static paths = all unique topic slugs used by Daytona posts
 */
export async function getStaticPaths() {
  const all = await getCollection("posts");
  const daytonaPosts = all.filter(isDaytonaPost);

  const keySet = new Set();

  for (const p of daytonaPosts) {
    const raw = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    for (const t of raw) {
      const k = tagKey(t);
      if (k) keySet.add(k);
    }
  }

  const keys = Array.from(keySet).sort((a, b) => a.localeCompare(b));
  return keys.map((key) => ({
    params: { slug: tagSlugFromKey(key) },
    props: { key },
  }));
}

/**
 * Page data
 */
const { key } = Astro.props;

// Build list of posts for this topic
const all = await getCollection("posts");
const daytonaPosts = all.filter(isDaytonaPost).sort(sortNewestFirst);

const topicKey = String(key ?? "").trim();
const topicSlug = tagSlugFromKey(topicKey);
const topicLabel = tagLabelFromKey(topicKey);

// Filter: post must contain this canonical tag key
const postsForTopic = daytonaPosts.filter((p) => {
  const raw = Array.isArray(p?.data?.tags) ? p.data.tags : [];
  const keys = raw.map(tagKey).filter(Boolean);
  return keys.includes(topicKey);
});

const title = topicLabel || "Topic";
const subtitle = `${postsForTopic.length} post${postsForTopic.length === 1 ? "" : "s"}`;
---

<Base title={title} subtitle={subtitle} cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 860px;">
    <p class="crumb">
      <a href="/daytona/topics/">Topics</a>
      <span class="sep">/</span>
      <span>{topicLabel}</span>
    </p>

    <h1 class="h1">{topicLabel}</h1>
    <p class="lede" style="opacity:.75;margin-top:8px;">
      {postsForTopic.length} post{postsForTopic.length === 1 ? "" : "s"} tagged “{topicLabel}”
    </p>

    {postsForTopic.length === 0 ? (
      <div class="empty">
        <p style="margin:0;">No posts found for this topic.</p>
      </div>
    ) : (
      <ul class="postList">
        {postsForTopic.map((p) => {
          const t = p.data.title ?? p.slug;
          const desc = p.data.description ?? "";
          const d = getPostDate(p);
          const dateText = d ? new Date(d).toLocaleDateString("en-US") : "";

          // Optional: show THIS topic as a pill next to date (consistent)
          return (
            <li class="postItem">
              <a class="stretched" href={`/daytona/posts/${p.slug}/`} aria-label={t}></a>

              <div class="postTop">
                <div class="postTitle">{t}</div>
              </div>

              {desc && <div class="postDesc">{desc}</div>}

              <div class="metaRow">
                {dateText && <span class="postDate">{dateText}</span>}
                {/* show the topic pill so users see what they’re browsing */}
                <a class="topicPill" href={`/daytona/topic/${topicSlug}/`}>{topicLabel}</a>
              </div>
            </li>
          );
        })}
      </ul>
    )}

    <p style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/posts/">← All posts</a>
      <a class="pill" href="/daytona/topics/">All topics</a>
    </p>
  </div>
</section>

<style>
  .crumb {
    margin: 0 0 10px 0;
    opacity: .75;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    font-size: 13px;
  }
  .crumb a { text-decoration: none; }
  .sep { opacity: .5; }

  .empty {
    margin-top: 16px;
    padding: 16px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    opacity: .9;
  }

  .postList {
    list-style: none;
    padding: 0;
    margin: 18px 0 0 0;
    display: grid;
    gap: 14px;
  }

  .postItem {
    position: relative;
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    padding: 14px 16px;
    background: rgba(255,255,255,.03);
  }

  /* whole card clickable, without breaking pill clicks */
  .stretched {
    position: absolute;
    inset: 0;
    border-radius: 14px;
    z-index: 1;
  }

  /* ensure real interactive elements sit above stretched link */
  .postItem a.topicPill { position: relative; z-index: 2; }

  .postTop {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: flex-start;
    position: relative;
    z-index: 2;
  }

  .postTitle {
    font-weight: 900;
    font-size: 18px;
    line-height: 1.25;
  }

  .postDesc {
    margin-top: 6px;
    opacity: .85;
    position: relative;
    z-index: 2;

    /* clamp to 2 lines for clean list */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .metaRow {
    margin-top: 10px;
    display: inline-flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    opacity: .72;
    position: relative;
    z-index: 2;
  }

  .postDate {
    font-size: 0.95em;
  }

  /* Smaller + slightly faded yellow pill (same vibe as your posts list) */
  .topicPill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 5px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 900;
    letter-spacing: .02em;
    text-decoration: none;

    color: #111;
    background: rgba(255, 220, 80, 0.65);
    border: 1px solid rgba(255, 220, 80, 0.55);
  }

  .topicPill:hover {
    background: rgba(255, 220, 80, 0.75);
    border-color: rgba(255, 220, 80, 0.70);
  }
</style>

