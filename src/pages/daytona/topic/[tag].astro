---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

function slugifyTag(tag) {
  return String(tag ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

export async function getStaticPaths() {
  const posts = await getCollection("posts");

  // only Daytona posts
  const daytonaPosts = posts.filter((p) => (p.data.city ?? "daytona") === "daytona");

  // collect tags -> slug map
  const tagMap = new Map(); // slug -> original label
  for (const p of daytonaPosts) {
    const tags = Array.isArray(p.data.tags) ? p.data.tags : [];
    for (const t of tags) {
      const slug = slugifyTag(t);
      if (slug) tagMap.set(slug, t);
    }
  }

  return Array.from(tagMap.entries()).map(([slug, label]) => ({
    params: { tag: slug },
    props: { tagSlug: slug, tagLabel: label },
  }));
}

const { tagSlug, tagLabel } = Astro.props;

const posts = await getCollection("posts");
const all = posts.filter((p) => (p.data.city ?? "daytona") === "daytona");

const tagged = all
  .filter((p) => Array.isArray(p.data.tags) && p.data.tags.some((t) => slugifyTag(t) === tagSlug))
  .sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf());
---

<Base title={`Topic: ${tagLabel}`} subtitle="Browse posts by topic." cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 900px;">
    <h1 class="h1">Topic: {tagLabel}</h1>

    {tagged.length === 0 ? (
      <p>No posts yet for this topic.</p>
    ) : (
      <ul>
        {tagged.map((p) => (
          <li style="margin: 10px 0;">
            <a href={`/daytona/posts/${p.slug}/`}>{p.data.title}</a>
            <span style="opacity:.6"> — {new Date(p.data.pubDate).toLocaleDateString()}</span>
          </li>
        ))}
      </ul>
    )}

    <p style="margin-top: 22px">
      <a class="pill" href="/daytona/topics/">← All topics</a>
    </p>
  </div>
</section>
