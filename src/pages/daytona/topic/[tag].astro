---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/** Daytona filter (supports frontmatter city and legacy folder IDs) */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/** Canonical tag key */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  return s
    .split(" ")
    .map((w) => (w ? w[0].toUpperCase() + w.slice(1) : w))
    .join(" ");
}

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const daytonaPosts = posts.filter(isDaytonaPost);

  const keys = new Set();
  for (const p of daytonaPosts) {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    for (const t of rawTags) {
      const k = tagKey(t);
      if (k) keys.add(k);
    }
  }

  return Array.from(keys)
    .sort((a, b) => a.localeCompare(b))
    .map((k) => ({
      params: { tag: tagSlugFromKey(k) },
      props: { tagKeyValue: k },
    }));
}

const { tagKeyValue } = Astro.props;

const posts = (await getCollection("posts"))
  .filter(isDaytonaPost)
  .filter((p) => {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    return rawTags.map(tagKey).includes(tagKeyValue);
  })
  .sort((a, b) => {
    const da = new Date(a?.data?.date ?? 0).getTime();
    const db = new Date(b?.data?.date ?? 0).getTime();
    return db - da;
  });

const pageTitle = `${tagLabelFromKey(tagKeyValue)} • GoDoDaytona`;
const pageDescription = `Posts tagged "${tagLabelFromKey(tagKeyValue)}" in Daytona Beach.`;
---

<Base title={pageTitle} description={pageDescription}>
  <main class="container" style="max-width: 900px; padding: 24px 16px;">
    <a href="/daytona/topics/" style="opacity:.8;text-decoration:none;">← All topics</a>

    <h1 style="margin:14px 0 6px; font-size:34px; line-height:1.1;">
      {tagLabelFromKey(tagKeyValue)}
    </h1>

    <p style="opacity:.8; margin:0 0 18px;">
      {posts.length} post{posts.length === 1 ? "" : "s"}
    </p>

    {posts.length === 0 ? (
      <p style="opacity:.8;">No posts found for this topic yet.</p>
    ) : (
      <div style="display:flex; flex-direction:column; gap:12px;">
        {posts.map((p) => (
          <a href={`/daytona/posts/${p.slug}/`} style="display:block; text-decoration:none;">
            <div style="border: 1px solid rgba(255,255,255,.12); border-radius: 14px; padding: 14px 16px; background: rgba(255,255,255,.03);">
              <div style="font-weight:800; font-size:16px; line-height:1.25;">
                {p.data.title ?? p.slug}
              </div>

              {p.data.description ? (
                <div style="opacity:.82; margin-top:6px;">
                  {p.data.description}
                </div>
              ) : null}

              {p.data.date ? (
                <div style="opacity:.65; margin-top:8px; font-size:13px;">
                  {new Date(p.data.date).toLocaleDateString()}
                </div>
              ) : null}
            </div>
          </a>
        ))}
      </div>
    )}
  </main>
</Base>
