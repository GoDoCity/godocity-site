---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Rule A — Canonical Tag Normalization
 * - case-insensitive
 * - treats "motor sports", "motor-sports", "Motor Sports" as the same tag
 */

// canonical key for comparison/grouping
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

// URL slug from canonical key
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

// Display label from canonical key (Title Case)
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "";
  return s
    .split(" ")
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : ""))
    .join(" ");
}

export async function getStaticPaths() {
  // Define this INSIDE getStaticPaths to avoid Cloudflare/Astro scope issues
  function isDaytonaPost(post) {
    const city = String(post?.data?.city ?? "daytona").toLowerCase();
    if (city === "daytona") return true;
    return typeof post?.id === "string" && post.id.startsWith("daytona/");
  }

  const posts = (await getCollection("posts")).filter(isDaytonaPost);

  const slugs = new Set();

  for (const p of posts) {
    const tags = Array.isArray(p.data?.tags) ? p.data.tags : [];
    for (const raw of tags) {
      const key = tagKey(raw);
      if (!key) continue;

      const slug = tagSlugFromKey(key);
      if (!slug) continue;

      slugs.add(slug);
    }
  }

  return Array.from(slugs)
    .filter(Boolean)
    .map((tag) => ({
      params: { tag },
    }));
}

// ---- Page render ----
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

const tag = String(Astro.params.tag ?? "").trim();

const postsAll = (await getCollection("posts")).filter(isDaytonaPost);

// Find matching posts + best label for this tag slug
let label = tag;
const matched = [];

for (const p of postsAll) {
  const tags = Array.isArray(p.data?.tags) ? p.data.tags : [];
  for (const raw of tags) {
    const key = tagKey(raw);
    if (!key) continue;

    const slug = tagSlugFromKey(key);
    if (!slug) continue;

    if (slug === tag) {
      matched.push(p);
      label = tagLabelFromKey(key) || label;
      break;
    }
  }
}

const posts = matched
  .slice()
  .sort((a, b) => +new Date(b.data.pubDate) - +new Date(a.data.pubDate));
---

<Base title={`Topic: ${label}`} subtitle="Browse posts by topic." cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 980px;">
    <h1 class="h1">{label}</h1>
    <p class="lede" style="opacity:.8">Posts tagged “{label}”.</p>

    {posts.length ? (
      <div style="margin-top:18px;display:grid;gap:12px;">
        {posts.map((p) => (
          <a class="card" href={`/daytona/posts/${p.slug}/`} style="display:block;padding:16px;">
            <div style="font-weight:700">{p.data.title}</div>
            {p.data.description && <div style="opacity:.8;margin-top:4px">{p.data.description}</div>}
            <div style="opacity:.6;margin-top:6px">
              {new Date(p.data.pubDate).toLocaleDateString()}
            </div>
          </a>
        ))}
      </div>
    ) : (
      <div class="card" style="margin-top:18px;padding:18px;">
        No posts found for this topic yet.
      </div>
    )}

    <p style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/topics/">← All topics</a>
      <a class="pill" href="/daytona/posts/">All posts</a>
      <a class="pill" href="/daytona/">Daytona home</a>
    </p>
  </div>
</section>
