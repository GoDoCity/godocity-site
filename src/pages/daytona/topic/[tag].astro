---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

function cityOf(p) {
  // Prefer explicit frontmatter
  if (p.data?.city) return String(p.data.city).toLowerCase();

  // If legacy folder structure is used, infer city from id like "daytona/xxxx.md"
  if (typeof p.id === "string" && p.id.startsWith("daytona/")) return "daytona";

  // Default
  return "daytona";
}

function slugifyTag(tag) {
  return String(tag ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

function displayTag(tag) {
  return String(tag ?? "").trim().replace(/\s+/g, " ");
}

export async function getStaticPaths() {
  const posts = (await getCollection("posts")).filter((p) => cityOf(p) === "daytona");

  // slug -> { label, posts[] }
  const map = new Map();

  for (const p of posts) {
    const tags = Array.isArray(p.data?.tags) ? p.data.tags : [];
    for (const raw of tags) {
      const slug = slugifyTag(raw);
      if (!slug) continue;

      const label = displayTag(raw);
      const existing = map.get(slug);
      if (!existing) map.set(slug, { label, posts: [p] });
      else map.set(slug, { label: existing.label, posts: [...existing.posts, p] });
    }
  }

  return Array.from(map.entries()).map(([tag, v]) => ({
    params: { tag },
    props: { tag, label: v.label, posts: v.posts },
  }));
}

const { label, posts } = Astro.props;
---

<Base title={`Topic: ${label}`} subtitle="Browse posts by topic." cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 980px;">
    <h1 class="h1">{label}</h1>
    <p class="lede" style="opacity:.8">Posts tagged “{label}”.</p>

    {posts?.length ? (
      <div style="margin-top:18px;display:grid;gap:12px;">
        {posts
          .slice()
          .sort((a, b) => +new Date(b.data.pubDate) - +new Date(a.data.pubDate))
          .map((p) => (
            <a class="card" href={`/daytona/posts/${p.slug}/`} style="display:block;padding:16px;">
              <div style="font-weight:700">{p.data.title}</div>
              {p.data.description && <div style="opacity:.8;margin-top:4px">{p.data.description}</div>}
              <div style="opacity:.6;margin-top:6px">
                {new Date(p.data.pubDate).toLocaleDateString()}
              </div>
            </a>
          ))}
      </div>
    ) : (
      <div class="card" style="margin-top:18px;padding:18px;">
        No posts found for this topic yet.
      </div>
    )}

    <p style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/topics/">← All topics</a>
      <a class="pill" href="/daytona/posts/">All posts</a>
      <a class="pill" href="/daytona/">Daytona home</a>
    </p>
  </div>
</section>
