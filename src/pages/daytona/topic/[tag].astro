---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona filter (supports frontmatter city and legacy folder IDs)
 * Build-safe: defined locally (no external references)
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/** Build-safe date getter (no external helper refs) */
function getPostDate(post) {
  const d =
    post?.data?.date ??
    post?.data?.pubDate ??
    post?.data?.published ??
    post?.data?.updated ??
    null;
  return d ? new Date(d) : null;
}

/** Canonical tag key (normalize tags for matching) */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/** Turn canonical key into label */
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim();
  if (!s) return "Topic";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w[0].toUpperCase() + w.slice(1) : w))
    .join(" ");
}

/** Feature flag helper */
function isFeatured(post) {
  const v = post?.data?.featured;
  if (v === true || v === 1) return true;
  const s = String(v ?? "").toLowerCase().trim();
  return s === "true" || s === "yes" || s === "1";
}

/**
 * Static paths: build all /daytona/topic/<tag> pages
 * Build-safe: no external helper refs
 */
export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const daytonaPosts = posts.filter(isDaytonaPost);

  const keys = new Set();
  for (const p of daytonaPosts) {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    for (const t of rawTags) {
      const k = tagKey(t);
      if (k) keys.add(k);
    }
  }

  return Array.from(keys)
    .sort((a, b) => a.localeCompare(b))
    .map((k) => ({
      params: { tag: tagSlugFromKey(k) },
      props: { tagKeyValue: k },
    }));
}

const { tagKeyValue } = Astro.props;
const tagParam = Astro.params.tag;

// Load posts for this topic page
const posts = (await getCollection("posts"))
  .filter(isDaytonaPost)
  .filter((p) => {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    return rawTags.map(tagKey).includes(tagKeyValue);
  })
  .sort((a, b) => {
    const da = getPostDate(a)?.getTime() ?? 0;
    const db = getPostDate(b)?.getTime() ?? 0;
    return db - da;
  });

const topicLabel = tagLabelFromKey(tagKeyValue);
---

<Base title={`Topic: ${topicLabel}`} description={`Posts tagged ${topicLabel} in Daytona.`}>
  <main class="container">
    <header class="header">
      <a class="back" href="/daytona/topics/">← All topics</a>
      <h1>{topicLabel}</h1>
      <p class="meta">
        Showing {posts.length} post{posts.length === 1 ? "" : "s"} tagged “{topicLabel}”
      </p>
    </header>

    <section class="list">
      {posts.length === 0 ? (
        <p>No posts found for this topic.</p>
      ) : (
        <ul>
          {posts.map((p) => (
            <li class={isFeatured(p) ? "featured" : ""}>
              <a href={`/daytona/posts/${p.slug}/`}>
                <span class="title">{p.data.title}</span>
                <span class="date">
                  {getPostDate(p)
                    ? getPostDate(p).toLocaleDateString("en-US", {
                        year: "numeric",
                        month: "short",
                        day: "numeric",
                      })
                    : ""}
                </span>
              </a>
            </li>
          ))}
        </ul>
      )}
    </section>
  </main>

  <style>
    .container{max-width:900px;margin:0 auto;padding:24px}
    .header{margin-bottom:18px}
    .back{display:inline-block;margin-bottom:10px;opacity:.8}
    .meta{opacity:.75;margin:6px 0 0}
    ul{list-style:none;padding:0;margin:0}
    li{border:1px solid rgba(255,255,255,.08);border-radius:12px;margin:10px 0}
    li a{display:flex;justify-content:space-between;gap:12px;padding:14px 16px}
    .title{font-weight:600}
    .date{opacity:.7;white-space:nowrap}
    .featured{border-color:rgba(255,210,74,.35)}
  </style>
</Base>
