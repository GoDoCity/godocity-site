---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/* ===========================
   STATIC PATHS (ISOLATED)
   =========================== */
export async function getStaticPaths() {
  const posts = await getCollection("posts");

  const normalizeKey = (raw) =>
    String(raw ?? "")
      .toLowerCase()
      .trim()
      .replace(/[-_]+/g, " ")
      .replace(/\s+/g, " ");

  const slugify = (key) =>
    String(key ?? "")
      .replace(/&/g, "and")
      .replace(/[^a-z0-9]+/gi, "-")
      .replace(/(^-|-$)/g, "")
      .toLowerCase();

  const isDaytona = (post) => {
    const city = String(post?.data?.city ?? "daytona").toLowerCase();
    if (city === "daytona") return true;
    return typeof post?.id === "string" && post.id.startsWith("daytona/");
  };

  const tags = new Set();

  for (const post of posts.filter(isDaytona)) {
    const list = Array.isArray(post.data?.tags) ? post.data.tags : [];
    for (const raw of list) {
      const key = normalizeKey(raw);
      const slug = slugify(key);
      if (slug) tags.add(slug);
    }
  }

  return [...tags].map((tag) => ({
    params: { tag },
  }));
}

/* ===========================
   PAGE RENDER
   =========================== */
const { tag } = Astro.params;
const posts = await getCollection("posts");

const normalizeKey = (raw) =>
  String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");

const slugify = (key) =>
  String(key ?? "")
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/gi, "-")
    .replace(/(^-|-$)/g, "")
    .toLowerCase();

const labelize = (key) =>
  key
    .split(" ")
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");

const isDaytona = (post) => {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
};

const matched = [];
let label = tag;

for (const post of posts.filter(isDaytona)) {
  const list = Array.isArray(post.data?.tags) ? post.data.tags : [];
  for (const raw of list) {
    const key = normalizeKey(raw);
    if (slugify(key) === tag) {
      matched.push(post);
      label = labelize(key);
      break;
    }
  }
}

matched.sort(
  (a, b) => new Date(b.data.pubDate) - new Date(a.data.pubDate)
);
---

<Base title={`Topic: ${label}`} subtitle="Browse posts by topic" cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 900px;">
    <h1 class="h1">{label}</h1>

    {matched.length ? (
      <div style="margin-top:20px;display:grid;gap:14px;">
        {matched.map((p) => (
          <a class="card" href={`/daytona/posts/${p.slug}/`}>
            <strong>{p.data.title}</strong>
            <div style="opacity:.7">{p.data.description}</div>
          </a>
        ))}
      </div>
    ) : (
      <p>No posts found for this topic yet.</p>
    )}

    <p style="margin-top:24px;">
      <a class="pill" href="/daytona/topics/">‚Üê All Topics</a>
    </p>
  </div>
</section>
