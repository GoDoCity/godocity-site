---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("posts");

  // Collect unique tags for Daytona posts
  const tags = new Set();
  for (const p of posts) {
    if ((p.data.city ?? "daytona") !== "daytona") continue;
    const list = Array.isArray(p.data.tags) ? p.data.tags : [];
    for (const t of list) {
      if (t) tags.add(String(t));
    }
  }

  return Array.from(tags).map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

const { tag } = Astro.props;

const posts = (await getCollection("posts"))
  .filter((p) => (p.data.city ?? "daytona") === "daytona")
  .filter((p) => (Array.isArray(p.data.tags) ? p.data.tags : []).includes(tag))
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());

const title = `#${tag}`;
const subtitle = `Posts tagged "${tag}"`;
const postUrl = (p) => `/daytona/posts/${p.slug}/`;
---
<Base title={title} subtitle={subtitle} cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 900px;">
    <h1 class="h1">{title}</h1>
    <p class="lede">{subtitle}</p>

    {posts.length === 0 ? (
      <div class="card card-pad" style="margin-top:14px;">
        <div class="kicker">No posts yet</div>
        <p class="lede" style="margin-top:10px;">
          Add the tag <strong>{tag}</strong> to a post in Admin.
        </p>
      </div>
    ) : (
      <div style="display:grid;gap:14px;margin-top:14px;">
        {posts.map((p) => (
          <article class="card">
            <div class="article">
              <h3 style="margin:0 0 6px;font-size:18px;">
                <a href={postUrl(p)}>{p.data.title}</a>
              </h3>
              {p.data.description ? <p style="margin:0;opacity:.85;">{p.data.description}</p> : null}
              <p style="margin:10px 0 0;opacity:.6;font-size:13px;">
                {new Date(p.data.pubDate).toLocaleDateString()}
              </p>
            </div>
          </article>
        ))}
      </div>
    )}

    <p style="margin-top:22px">
      <a class="pill" href="/daytona/posts/">‚Üê All posts</a>
    </p>
  </div>
</section>
