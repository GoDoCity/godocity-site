---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona filter (supports frontmatter city and legacy folder IDs)
 * Build-safe: defined locally (no external references)
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/** Build-safe date getter (no external helper refs) */
function getPostDate(post) {
  const d =
    post?.data?.date ??
    post?.data?.pubDate ??
    post?.data?.published ??
    post?.data?.updated ??
    null;
  return d ? new Date(d) : null;
}

/** Canonical tag key (normalize tags for matching) */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

/** Turn canonical key into URL slug */
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/** Turn canonical key into label */
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim();
  if (!s) return "Topic";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w[0].toUpperCase() + w.slice(1) : w))
    .join(" ");
}

/**
 * Static paths: build all /daytona/topic/<tag> pages
 * Build-safe: no external helper refs
 */
export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const daytonaPosts = posts.filter(isDaytonaPost);

  const keys = new Set();
  for (const p of daytonaPosts) {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    for (const t of rawTags) {
      const k = tagKey(t);
      if (k) keys.add(k);
    }
  }

  return Array.from(keys)
    .sort((a, b) => a.localeCompare(b))
    .map((k) => ({
      params: { tag: tagSlugFromKey(k) },
      props: { tagKeyValue: k },
    }));
}

const { tag } = Astro.params;
const { tagKeyValue } = Astro.props;

// Fallback: if Astro.props isn't present (edge cases), derive from URL param
const activeKey = tagKeyValue ?? tagKey(tag);

// Pull & filter posts for this topic
const allPosts = await getCollection("posts");

const posts = allPosts
  .filter(isDaytonaPost)
  .filter((p) => {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    const keys = rawTags.map(tagKey).filter(Boolean);
    return keys.includes(activeKey);
  })
  .sort((a, b) => {
    const da = getPostDate(a)?.getTime() ?? 0;
    const db = getPostDate(b)?.getTime() ?? 0;
    return db - da;
  });

const label = tagLabelFromKey(activeKey);
const pageTitle = `${label} – GoDoDaytona`;
const subtitle = `Posts tagged “${label}”`;
---

<Base title={pageTitle} description={subtitle}>
  <section class="container">
    <div style="margin: 24px 0 10px;">
      <a href="/daytona/topics/">← All Topics</a>
    </div>

    <h1 style="margin: 0 0 6px;">{label}</h1>
    <p style="margin: 0 0 22px; opacity: 0.8;">{subtitle}</p>

    {posts.length === 0 ? (
      <p>No posts found for this topic.</p>
    ) : (
      <ul style="list-style:none; padding:0; margin:0; display:grid; gap:14px;">
        {posts.map((post) => {
          const title = post?.data?.title ?? post.slug;
          const desc = post?.data?.description ?? "";
          const d = getPostDate(post);
          const dateText = d ? d.toLocaleDateString() : "";

          return (
            <li style="border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:14px 16px;">
              <a href={`/daytona/posts/${post.slug}/`} style="display:block;">
                <div style="font-weight:700; font-size:1.05rem; margin-bottom:6px;">
                  {title}
                </div>

                {(dateText || desc) && (
                  <div style="opacity:.75; font-size:.95rem;">
                    {dateText && <span>{dateText}</span>}
                    {dateText && desc && <span> • </span>}
                    {desc && <span>{desc}</span>}
                  </div>
                )}
              </a>
            </li>
          );
        })}
      </ul>
    )}
  </section>
</Base>
