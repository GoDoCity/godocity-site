---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona filter (supports frontmatter city and legacy folder IDs)
 * Build-safe: defined locally (no external references)
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/** Build-safe date getter (no external helper refs) */
function getPostDate(post) {
  const d =
    post?.data?.date ??
    post?.data?.pubDate ??
    post?.data?.published ??
    post?.data?.updated ??
    null;
  return d ? new Date(d) : null;
}

/** Canonical tag key (normalize tags for matching) */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

/** Convert canonical key to URL slug */
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/** Turn canonical key into label */
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim().replace(/\s+/g, " ");
  if (!s) return "Topic";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w[0].toUpperCase() + w.slice(1) : w))
    .join(" ");
}

/**
 * Static paths: build all /daytona/topic/<tag> pages
 * Build-safe: no external helper refs
 */
export async function getStaticPaths() {
  const all = await getCollection("posts");
  const daytonaPosts = all.filter(isDaytonaPost);

  const keys = new Set();
  for (const p of daytonaPosts) {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    for (const t of rawTags) {
      const k = tagKey(t);
      if (k) keys.add(k);
    }
  }

  return Array.from(keys)
    .sort((a, b) => a.localeCompare(b))
    .map((k) => ({
      params: { tag: tagSlugFromKey(k) },
      props: { tagKeyValue: k },
    }));
}

const { tagKeyValue } = Astro.props;
const tagParam = Astro.params.tag;

// Load posts for this topic page
const posts = (await getCollection("posts"))
  .filter(isDaytonaPost)
  .filter((p) => {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    return rawTags.map(tagKey).includes(tagKeyValue);
  })
  .sort((a, b) => {
    const da = (getPostDate(a) ?? new Date(0)).getTime();
    const db = (getPostDate(b) ?? new Date(0)).getTime();
    return db - da; // newest first
  });

const title = `${tagLabelFromKey(tagKeyValue)} | GoDo Daytona`;
const description = `Posts tagged ${tagLabelFromKey(tagKeyValue)} in Daytona Beach.`;
---

<Base title={title} description={description}>
  <main class="container">
    <header class="page-head">
      <p class="kicker">
        <a href="/daytona/topics/">Topics</a>
        <span aria-hidden="true"> / </span>
        <span>{tagParam}</span>
      </p>
      <h1>{tagLabelFromKey(tagKeyValue)}</h1>
      <p class="muted">{posts.length} post{posts.length === 1 ? "" : "s"}</p>
    </header>

    {posts.length === 0 ? (
      <p>No posts found for this topic.</p>
    ) : (
      <ul class="list">
        {posts.map((p) => (
          <li class="item">
            <a href={`/daytona/posts/${p.slug}/`}>
              <strong>{p.data.title}</strong>
            </a>
            <div class="meta">
              {getPostDate(p) ? getPostDate(p).toLocaleDateString() : ""}
            </div>
            {p.data.description ? <p class="desc">{p.data.description}</p> : null}
          </li>
        ))}
      </ul>
    )}
  </main>
</Base>

<style>
  .container{max-width:980px;margin:0 auto;padding:28px 18px}
  .page-head{margin-bottom:18px}
  .kicker{margin:0 0 8px 0;font-size:14px;opacity:.8}
  .muted{margin:6px 0 0 0;opacity:.8}
  .list{list-style:none;padding:0;margin:18px 0;display:grid;gap:14px}
  .item{padding:14px;border:1px solid rgba(255,255,255,.08);border-radius:12px}
  .meta{font-size:13px;opacity:.75;margin-top:6px}
  .desc{margin:8px 0 0 0;opacity:.9}
</style>
