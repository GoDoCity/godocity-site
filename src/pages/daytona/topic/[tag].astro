---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("posts", (p) => p.data.city === "daytona");

  const tags = new Set();
  for (const p of posts) {
    for (const t of (p.data.tags ?? [])) tags.add(t);
  }

  return Array.from(tags).sort().map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;

const posts = (await getCollection(
  "posts",
  (p) => p.data.city === "daytona" && (p.data.tags ?? []).includes(tag)
)).sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
---

<Base title={`${tag} | GoDoDaytona`} subtitle={`Posts tagged “${tag}” in Daytona Beach.`} cityBase="daytona">
  <section class="section">
    <div class="container">
      <h2 style="text-transform:capitalize">{tag}</h2>

      <div class="card">
        {posts.length ? (
          posts.map((p) => (
            <div class="article">
              <h3>
                <a href={`/daytona/posts/${p.slug}/`}>{p.data.title}</a>
              </h3>
              <p>{p.data.description}</p>
            </div>
          ))
        ) : (
          <div class="article">
            <p>No posts yet for this topic.</p>
          </div>
        )}
      </div>
    </div>
  </section>
</Base>
