---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/* ===========================
   STATIC PATHS (ISOLATED)
   =========================== */
export async function getStaticPaths() {
  const posts = await getCollection("posts");

  const normalizeKey = (raw) =>
    String(raw ?? "")
      .toLowerCase()
      .trim()
      .replace(/[-_]+/g, " ")
      .replace(/\s+/g, " ");

  const slugify = (key) =>
    String(key ?? "")
      .replace(/&/g, "and")
      .replace(/[^a-z0-9]+/gi, "-")
      .replace(/(^-|-$)/g, "")
      .toLowerCase();

  const isDaytona = (post) => {
    const city = String(post?.data?.city ?? "daytona").toLowerCase();
    if (city === "daytona") return true;
    return typeof post?.id === "string" && post.id.startsWith("daytona/");
  };

  const tags = new Set();

  for (const post of posts.filter(isDaytona)) {
    const list = Array.isArray(post.data?.tags) ? post.data.tags : [];
    for (const raw of list) {
      const key = normalizeKey(raw);
      const slug = slugify(key);
      if (slug) tags.add(slug);
    }
  }

  return [...tags].map((tag) => ({
    params: { tag },
  }));
}

/* ===========================
   PAGE RENDER
   =========================== */
const { tag } = Astro.params;
const postsAll = await getCollection("posts");

const normalizeKey = (raw) =>
  String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");

const slugify = (key) =>
  String(key ?? "")
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/gi, "-")
    .replace(/(^-|-$)/g, "")
    .toLowerCase();

const labelize = (key) =>
  key
    .split(" ")
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");

const isDaytona = (post) => {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
};

const matched = [];
let label = tag;

for (const post of postsAll.filter(isDaytona)) {
  const list = Array.isArray(post.data?.tags) ? post.data.tags : [];
  for (const raw of list) {
    const key = normalizeKey(raw);
    if (slugify(key) === tag) {
      matched.push(post);
      label = labelize(key);
      break;
    }
  }
}

matched.sort((a, b) => new Date(b.data.pubDate) - new Date(a.data.pubDate));

const count = matched.length;
---

<Base title={`Topic: ${label}`} subtitle="Browse posts by topic" cityBase="daytona" />

<section class="section">
  <div class="container" style="max-width: 980px;">
    <div style="display:flex;align-items:baseline;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <h1 class="h1" style="margin:0;">{label}</h1>
      <div style="opacity:.7;font-weight:700;">
        {count} {count === 1 ? "post" : "posts"}
      </div>
    </div>

    <p class="lede" style="opacity:.82;margin-top:8px;">
      Newest first. Click any post to read.
    </p>

    {matched.length ? (
      <div style="margin-top:18px;display:grid;gap:12px;">
        {matched.map((p) => (
          <a class="card" href={`/daytona/posts/${p.slug}/`} style="display:block;padding:16px;">
            <div style="font-weight:900">{p.data.title}</div>
            {p.data.description && (
              <div style="opacity:.82;margin-top:4px">{p.data.description}</div>
            )}
            <div style="opacity:.6;margin-top:6px">
              {new Date(p.data.pubDate).toLocaleDateString()}
            </div>
          </a>
        ))}
      </div>
    ) : (
      <div class="card" style="margin-top:18px;padding:18px;">
        No posts found for this topic yet.
      </div>
    )}

    <div style="margin-top:22px;display:flex;gap:10px;flex-wrap:wrap;">
      <a class="pill" href="/daytona/topics/">‚Üê All topics</a>
      <a class="pill" href="/daytona/posts/">All posts</a>
      <a class="pill" href="/daytona/">Daytona home</a>
    </div>
  </div>
</section>
