---
import Base from "../../../layouts/Base.astro";
import { getCollection } from "astro:content";

/**
 * Daytona filter (supports frontmatter city and legacy folder IDs)
 * Build-safe: defined locally (no external references)
 */
function isDaytonaPost(post) {
  const city = String(post?.data?.city ?? "daytona").toLowerCase();
  if (city === "daytona") return true;
  return typeof post?.id === "string" && post.id.startsWith("daytona/");
}

/** Canonical tag key (normalize tags for matching) */
function tagKey(raw) {
  return String(raw ?? "")
    .toLowerCase()
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ");
}

/** URL slug for the route param */
function tagSlugFromKey(key) {
  return String(key ?? "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/** Display label */
function tagLabelFromKey(key) {
  const s = String(key ?? "").trim();
  if (!s) return "Topic";
  return s
    .split(" ")
    .filter(Boolean)
    .map((w) => (w ? w[0].toUpperCase() + w.slice(1) : w))
    .join(" ");
}

/**
 * Static paths: build all /daytona/topic/<tag> pages
 * Build-safe: no external helper refs
 */
export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const daytonaPosts = posts.filter(isDaytonaPost);

  const keys = new Set();
  for (const p of daytonaPosts) {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    for (const t of rawTags) {
      const k = tagKey(t);
      if (k) keys.add(k);
    }
  }

  return Array.from(keys)
    .sort((a, b) => a.localeCompare(b))
    .map((k) => ({
      params: { tag: tagSlugFromKey(k) },
      props: { tagKeyValue: k },
    }));
}

const { tagKeyValue } = Astro.props;

// Load posts for this topic page (Daytona-only, matching canonical key)
const posts = (await getCollection("posts"))
  .filter(isDaytonaPost)
  .filter((p) => {
    const rawTags = Array.isArray(p?.data?.tags) ? p.data.tags : [];
    return rawTags.map(tagKey).includes(tagKeyValue);
  })
  .sort((a, b) => {
    const da = new Date(a?.data?.date ?? a?.data?.pubDate ?? 0).getTime();
    const db = new Date(b?.data?.date ?? b?.data?.pubDate ?? 0).getTime();
    return db - da;
  });

const topicTitle = tagLabelFromKey(tagKeyValue);
---

<Base title={`GoDo Daytona — ${topicTitle}`} description={`Posts tagged ${topicTitle}`}>
  <main class="container">
    <header class="pagehead">
      <p class="kicker">Topic</p>
      <h1>{topicTitle}</h1>
      <p class="sub">
        {posts.length} post{posts.length === 1 ? "" : "s"}
      </p>
      <p class="back">
        <a href="/daytona/topics/">← All topics</a>
      </p>
    </header>

    {posts.length ? (
      <ul class="grid">
        {posts.map((p) => (
          <li class="card">
            <a class="cardLink" href={`/daytona/posts/${p.slug}/`}>
              <h2 class="cardTitle">{p.data.title}</h2>
              {p.data.description ? (
                <p class="cardDesc">{p.data.description}</p>
              ) : null}
              <p class="meta">
                {p.data.date
                  ? new Date(p.data.date).toLocaleDateString("en-US", {
                      year: "numeric",
                      month: "short",
                      day: "numeric",
                    })
                  : ""}
              </p>
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <p class="empty">No posts found for this topic yet.</p>
    )}
  </main>

  <style>
    {`
      .container{max-width:1100px;margin:0 auto;padding:28px 18px}
      .pagehead{margin:10px 0 22px}
      .kicker{margin:0;color:var(--muted, #a8b3c2);text-transform:uppercase;letter-spacing:.08em;font-size:.78rem}
      h1{margin:.25rem 0 .35rem;font-size:2.1rem;line-height:1.15}
      .sub{margin:0 0 .6rem;color:var(--muted, #a8b3c2)}
      .back a{color:inherit;text-decoration:none;border-bottom:1px solid rgba(255,255,255,.18)}
      .back a:hover{opacity:.9}

      .grid{list-style:none;margin:0;padding:0;display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
      .card{background:var(--panel,#10141a);border:1px solid var(--line,#1f2631);border-radius:14px;overflow:hidden}
      .cardLink{display:block;padding:16px 16px 14px}
      .cardTitle{margin:0 0 .35rem;font-size:1.05rem;line-height:1.25}
      .cardDesc{margin:0 0 .6rem;color:var(--muted,#a8b3c2);font-size:.95rem}
      .meta{margin:0;color:var(--muted,#a8b3c2);font-size:.85rem}
      .empty{color:var(--muted,#a8b3c2)}
    `}
  </style>
</Base>
